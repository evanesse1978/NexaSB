<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXA - Insurance Manager</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">

        function updatePrevPersonalCommission(idx, val, perc, lock){
            try{
                const v = safeParseFloat(val) || 0;
                const p = safeParseFloat(perc) || 0;
                const cp = (lock ? 0 : (v * (p/100)));
                const el = document.getElementById('prev-cp-'+idx);
                if(el) el.innerText = '€ ' + cp.toFixed(2);
            } catch(e){ console.log('updatePrevPersonalCommission', e); }
        }

</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script></script>
    <script>

        // ==============================
        // REPORT - NEW VERSION
        // ==============================
        function initReportDefaults(){
        const now = new Date();
        const yearSel = document.getElementById('reportYear');
        if(yearSel && yearSel.options.length < 2){
            let html = '';
            for(let y = 2025; y <= 2050; y++){ html += `<option value="${y}">${y}</option>`; }
            yearSel.innerHTML = html;
            yearSel.value = String(now.getFullYear());
        }
        const monthSel = document.getElementById('reportMonth');
        if(monthSel && !monthSel.value) monthSel.value = String(now.getMonth()+1).padStart(2,'0');
    }

        function getReportDates(){
        const year = parseInt(document.getElementById('reportYear').value);
        const month = parseInt(document.getElementById('reportMonth').value);
        // Date sicure a mezzogiorno
        const start = new Date(year, month-1, 1, 12, 0, 0); 
        const end = new Date(year, month, 1, 12, 0, 0);
        return {start, end, year, month};
    }

        function parseISODate(d){
            if(!d) return null;
            const dt = new Date(d);
            if(isNaN(dt)) return null;
            dt.setHours(0,0,0,0);
            return dt;
        }

        function matchesReportFilters(p){
            const ramo = document.getElementById('reportRamo')?.value || 'TUTTI';
            const comp = document.getElementById('reportCompany')?.value || 'TUTTE';
            if(ramo!=='TUTTI' && String(p.ramo||'').toUpperCase()!==ramo) return false;

            if(comp!=='TUTTE'){
                const fixed = ['ALLIANZ','HDI','VITTORIA','GENIALPIU','HELVETIA','ARAG','METLIFE'];
                const fixedSet = new Set(fixed.map(x=>String(x).trim()));
                const pc = String(p.company||'').trim();

                if(comp==='ALTRE'){
                    if(!pc) return false;
                    if(fixedSet.has(pc)) return false;
                } else {
                    if(pc!==comp) return false;
                }
            }

            return true;
        }

        function computeReport(dates){
        const type = document.getElementById('reportType').value || 'PROD';
        const ramoFilter = document.getElementById('reportRamo').value;
        
        let rows = policies.filter(p => {
             // Filtro Ramo
             if(ramoFilter !== 'TUTTI' && (p.ramo||'').toUpperCase() !== ramoFilter) return false;
             return true;
        });

        if(type === 'PROD'){
            // Nuova Produzione: Effetto nel mese
            rows = rows.filter(p => {
                const d = parseISODate(p.effect);
                return d && d >= dates.start && d < dates.end;
            });
        } else if(type === 'LOST'){
            // Polizze Perse: Non attive, scadenza nel mese
            rows = rows.filter(p => {
                if(String(p.status) === 'ATTIVA' || String(p.status) === 'SOSPESA') return false;
                const d = parseISODate(p.expiry);
                return d && d >= dates.start && d < dates.end;
            });
        } else if(type === 'PORT'){
            // Portafoglio: Attive fino a data start
            rows = rows.filter(p => {
                if(String(p.status) === 'ATTIVA' || String(p.status) === 'SOSPESA'){
                    const eff = parseISODate(p.effect);
                    return eff && eff <= dates.start;
                }
                return false;
            });
        }

        const count = rows.length;
        const premium = rows.reduce((s,p)=> s + safeParseFloat(p.annualPremium), 0);
        return {rows, count, premium};
    }

        function renderReport(){
        const dates = getReportDates();
        const cur = computeReport(dates);
        
        // Confronto anno precedente
        let prev = null;
        if(document.getElementById('reportCompare').checked){
            const prevDates = {
                start: new Date(dates.year-1, dates.month-1, 1, 12,0,0),
                end: new Date(dates.year-1, dates.month, 1, 12,0,0),
                year: dates.year-1, month: dates.month
            };
            prev = computeReport(prevDates);
        }

        const delta = prev ? (cur.premium - prev.premium) : 0;
        const deltaPerc = (prev && prev.premium>0) ? ((delta/prev.premium)*100) : null;

        document.getElementById('repCount').innerText = cur.count;
        document.getElementById('repPremium').innerText = '€ ' + cur.premium.toFixed(2);
        document.getElementById('repDelta').innerText = prev ? ('€ ' + delta.toFixed(2)) : '—';
        document.getElementById('repDeltaPerc').innerText = prev ? (deltaPerc!==null?deltaPerc.toFixed(1)+'%':'—') : '—';

        const tb = document.getElementById('reportTableBody');
        tb.innerHTML = '';
        if(cur.rows.length === 0){
            tb.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-slate-500">Nessun dato trovato.</td></tr>';
            window.__lastReportRows = [];
            return;
        }

        const rowsOut = [];
        cur.rows.forEach(p => {
            const c = clients.find(x => x.id === p.clientId);
            const cname = c ? c.name : 'Sconosciuto';
            const prem = safeParseFloat(p.annualPremium).toFixed(2);
            
            tb.innerHTML += `<tr class="hover:bg-slate-800/30">
                <td class="px-6 py-3 text-white font-medium">${cname}</td>
                <td class="px-6 py-3">${p.ramo||''}</td>
                <td class="px-6 py-3">${p.company||''}</td>
                <td class="px-6 py-3 font-mono text-xs">${p.policyNumber||''}</td>
                <td class="px-6 py-3 text-xs">${p.effect||''}</td>
                <td class="px-6 py-3 text-xs">${p.expiry||''}</td>
                <td class="px-6 py-3 text-right text-white">€ ${prem}</td>
                <td class="px-6 py-3">${p.status}</td>
            </tr>`;

            rowsOut.push({
                cliente: cname, ramo: p.ramo, compagnia: p.company, 
                polizza: p.policyNumber, effetto: p.effect, scadenza: p.expiry, 
                premio: prem, stato: p.status
            });
        });
        window.__lastReportRows = rowsOut;
    }

        function extractReport(){
        renderReport();
        const rows = window.__lastReportRows || [];
        if(!rows.length) return alert("Nessun dato da estrarre.");

        const headers = Object.keys(rows[0]);
        const esc = (v) => ('"' + String(v||'').replace(/"/g, '""') + '"');
        
        // Costruisci righe CSV
        const lines = [headers.map(esc).join(';')];
        rows.forEach(r => {
            lines.push(headers.map(h => esc(r[h])).join(';'));
        });

        // FIX CRITICO: Usa \n invece di andare a capo nel codice
        const csv = lines.join('\n');

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${document.getElementById('reportType').value}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

        function exportReportPDF(){
        renderReport();
        const rows = window.__lastReportRows || [];
        if(!rows.length) return alert("Nessun dato.");
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        
        const title = `Report ${document.getElementById('reportType').value} - ${document.getElementById('reportMonth').value}/${document.getElementById('reportYear').value}`;
        doc.text(title, 14, 15);
        
        const body = rows.map(r => Object.values(r));
        const head = [Object.keys(rows[0]).map(k => k.toUpperCase())];

        doc.autoTable({
            head: head,
            body: body,
            startY: 20,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [5, 7, 20] }
        });
        
        doc.save('report_nexa.pdf');
    }

</script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeSettingsModal()"></div>
        <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-full max-w-lg px-4">
            <div class="bg-surface border border-slate-700 rounded-2xl shadow-2xl p-6 relative border-t-4 border-t-accent">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-lg font-bold text-white"><i class="fa-solid fa-gear mr-2 text-accent"></i>Impostazioni</h3>
                    <button onclick="closeSettingsModal()" class="text-slate-500 hover:text-accent"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="bg-slate-800/30 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Tema</div>
                    <div class="flex gap-3">
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="theme" value="dark" class="peer hidden" onchange="setTheme('dark')">
                            <div class="peer-checked:bg-accent peer-checked:text-darktext px-4 py-3 rounded-xl bg-deep text-slate-300 border border-slate-700 text-sm font-bold text-center">Scuro</div>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="theme" value="light" class="peer hidden" onchange="setTheme('light')">
                            <div class="peer-checked:bg-accent peer-checked:text-darktext px-4 py-3 rounded-xl bg-deep text-slate-300 border border-slate-700 text-sm font-bold text-center">Chiaro</div>
                        </label>
                    </div>
                    <div class="text-10px text-slate-500 mt-3">Il tema viene salvato in locale e resta attivo ai prossimi accessi.</div>
                </div>
            </div>
        </div>
    </div>

    

<!-- AVATAR PICKER MODAL -->
<div id="avatarModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black80 backdrop-blur-sm" onclick="closeAvatarPicker()"></div>
  <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-full max-w-lg px-4">
    <div class="bg-surface border border-slate-700 rounded-2xl shadow-2xl p-6 relative border-t-4 border-t-accent">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-white"><i class="fa-solid fa-user-astronaut mr-2 text-accent"></i>Seleziona avatar</h3>
        <button onclick="closeAvatarPicker()" class="text-slate-500 hover:text-accent"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div id="avatarGrid" class="grid grid-cols-5 sm:grid-cols-6 gap-3"></div>
      <p class="text-10px text-slate-500 mt-4">L'avatar viene salvato nel profilo utente.</p>
    </div>
  </div>
</div>
<script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        signature: ['"Dancing Script"', 'cursive'],
                    },
                    colors: {
                        deep: '#050714',       
                        surface: '#0B1121',    
                        accent: '#E2FF00',     
                        glow: '#E2FF00',       
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        darktext: '#0f172a'    
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #050714; }
        ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #374151; }
        .glass-effect { background: rgba(11, 17, 33, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .nav-active { background-color: rgba(226, 255, 0, 0.1); color: white; border: 1px solid rgba(226, 255, 0, 0.4); box-shadow: 0 0 15px -3px rgba(226, 255, 0, 0.2); }
        .nav-active i { color: #E2FF00; } 
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        select option { background-color: #0B1121; color: white; }
        .branch-auto { border-left: 4px solid #3b82f6; } .branch-vita { border-left: 4px solid #10b981; } .branch-vari { border-left: 4px solid #f59e0b; }
        .status-cancelled { text-decoration: line-through; opacity: 0.5; color: #ef4444; }
        .status-suspended { opacity: 0.8; border-left: 4px solid #7c3aed; }
        
        /* Classi colori scadenze */
        .row-expired { background-color: rgba(239, 68, 68, 0.15); border-left: 3px solid #ef4444; } /* Rosso */
        .row-warning { background-color: rgba(245, 158, 11, 0.15); border-left: 3px solid #f59e0b; } /* Arancione */
        .row-paid { background-color: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; } /* Verde */

        /* Calendario Styles */
        .calendar-day-header { font-size: 0.7rem; text-transform: uppercase; color: #64748b; padding-bottom: 0.5rem; text-align: center; }
        .calendar-cell { min-height: 80px; border: 1px solid rgba(51, 65, 85, 0.3); padding: 0.5rem; position: relative; transition: all 0.2s; }
        .calendar-cell:hover { background-color: rgba(30, 41, 59, 0.5); }
        .calendar-cell.today { background-color: rgba(226, 255, 0, 0.05); border-color: rgba(226, 255, 0, 0.3); }
        .calendar-cell.inactive { opacity: 0.3; background-color: rgba(0,0,0,0.2); }
        .event-chip { font-size: 0.65rem; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-chip-auto { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; border-left: 2px solid #3b82f6; }
        .event-chip-gen { background-color: rgba(226, 255, 0, 0.1); color: #E2FF00; border-left: 2px solid #E2FF00; }
    

        /* THEME LIGHT OVERRIDES (READABLE) */
/* Obiettivo: niente giallo fluo con testo chiaro, e contrasto alto in light mode */
.theme-light body {
  background-color: #f8fafc !important;
  color: #0f172a !important;
}

/* Superfici e testi */
.theme-light .bg-deep { background-color: #f8fafc !important; }
.theme-light .bg-deep50 { background-color: rgba(248,250,252,0.75) !important; }
.theme-light .bg-deep30 { background-color: rgba(248,250,252,0.55) !important; }
.theme-light .bg-deep20 { background-color: rgba(248,250,252,0.40) !important; }
.theme-light .bg-surface { background-color: #ffffff !important; }

.theme-light .glass-effect {
  background: rgba(255,255,255,0.92) !important;
  border: 1px solid rgba(15,23,42,0.14) !important;
}

.theme-light .text-white { color: #0b1220 !important; }
.theme-light .text-slate-300 { color: #1f2937 !important; }
.theme-light .text-slate-400 { color: #334155 !important; }
.theme-light .text-slate-500 { color: #475569 !important; }

/* Inputs */
.theme-light input,
.theme-light textarea,
.theme-light select {
  background-color: #ffffff !important;
  color: #0f172a !important;
  border-color: #cbd5e1 !important;
}
.theme-light input::placeholder,
.theme-light textarea::placeholder {
  color: #64748b !important;
}
.theme-light select option {
  background-color: #ffffff !important;
  color: #0f172a !important;
}

/* Bordi/box secondari */
.theme-light .bg-slate-90050,
.theme-light .bg-slate-80050 {
  background-color: rgba(226,232,240,0.65) !important;
}
.theme-light .bg-slate-800 { background-color: #e2e8f0 !important; }

.theme-light .border-slate-700,
.theme-light .border-slate-800,
.theme-light .border-slate-80050 {
  border-color: #cbd5e1 !important;
}

/* --- FIX PRINCIPALE: ACCENT in light mode (blu) --- */
.theme-light .text-accent { color: #2563eb !important; }
.theme-light .bg-accent { background-color: #2563eb !important; color: #ffffff !important; }
.theme-light .border-accent { border-color: #2563eb !important; }

/* classi tailwind peer-checked */
.theme-light .peer-checked\:bg-accent { background-color: #2563eb !important; }
.theme-light .peer-checked\:text-darktext { color: #ffffff !important; }

/* gradient from-accent5 */
.theme-light .from-accent5 {
  --tw-gradient-from: rgba(37,99,235,0.10) var(--tw-gradient-from-position) !important;
  --tw-gradient-to: rgba(37,99,235,0) var(--tw-gradient-to-position) !important;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important;
}

/* Nav attiva */
.theme-light .nav-active {
  background-color: rgba(37,99,235,0.10) !important;
  color: #0b1220 !important;
  border: 1px solid rgba(37,99,235,0.35) !important;
  box-shadow: 0 0 15px -3px rgba(37,99,235,0.15) !important;
}
.theme-light .nav-active i { color: #2563eb !important; }

/* Chip agenda gen */
.theme-light .event-chip-gen {
  background-color: rgba(37,99,235,0.12) !important;
  color: #1d4ed8 !important;
  border-left-color: #2563eb !important;
}

/* Hover gialli hardcoded -> blu */
.theme-light .hover\:bg-yellow-400:hover { background-color: #1d4ed8 !important; }
.theme-light .hover\:bg-accent90:hover { background-color: #1d4ed8 !important; }

.theme-light .text-darktext { color: #0f172a !important; }



/* =========================================================
   EXTRA FIX: LIGHT THEME (contrast + hover + buttons)
   Obiettivo: in light mode niente testi “chiari” su fondo chiaro
   e niente testi “scuri” su fondo scuro, anche in hover.
========================================================= */

/* 1) Fix hover text (molti elementi usano hover:text-white) */
.theme-light .hover\:text-white:hover { color: #0b1220 !important; }
.theme-light .hover\:text-slate-300:hover { color: #0b1220 !important; }
.theme-light .hover\:text-slate-400:hover { color: #0b1220 !important; }
.theme-light .hover\:text-slate-500:hover { color: #0b1220 !important; }

/* 2) Fix hover background per classi molto usate */
.theme-light .hover\:bg-slate-800:hover { background-color: #cbd5e1 !important; }
.theme-light .hover\:bg-slate-700:hover { background-color: #cbd5e1 !important; }
.theme-light .hover\:bg-slate-600:hover { background-color: #cbd5e1 !important; }

.theme-light .hover\:bg-slate-800\/50:hover { background-color: rgba(226,232,240,0.85) !important; }
.theme-light .hover\:bg-slate-800\/30:hover { background-color: rgba(226,232,240,0.70) !important; }
.theme-light .hover\:bg-slate-900\/50:hover { background-color: rgba(226,232,240,0.85) !important; }

/* 3) Fix background “/30” e “/20” (box, card, righe tabella, ecc.) */
.theme-light .bg-slate-800\/30 { background-color: rgba(226,232,240,0.55) !important; }
.theme-light .bg-slate-800\/20 { background-color: rgba(226,232,240,0.40) !important; }

/* 4) Fix bottoni accent: in light mode l’accent diventa blu,
      quindi testo deve essere bianco anche se esiste text-darktext */
.theme-light .bg-accent.text-darktext { color: #ffffff !important; }
.theme-light .hover\:bg-yellow-400:hover.text-darktext { color: #ffffff !important; }
.theme-light .hover\:bg-accent90:hover.text-darktext { color: #ffffff !important; }

/* 5) Fix combinazione hover:bg-accent + hover:text-darktext (es. bottone “Oggi”) */
.theme-light .hover\:text-darktext:hover { color: #ffffff !important; }
.theme-light .hover\:bg-accent:hover { background-color: #1d4ed8 !important; }

/* 6) Uniforma alcuni bg/border grigi nel tema chiaro */
.theme-light .bg-slate-700 { background-color: #e2e8f0 !important; }
.theme-light .bg-slate-600 { background-color: #e2e8f0 !important; }

.theme-light .border-slate-600,
.theme-light .border-slate-500 { border-color: #cbd5e1 !important; }

/* 7) Checkbox/radio: accent coerente con accent blu in light mode */
.theme-light .accent-accent { accent-color: #2563eb !important; }

/* =========================================================
   MOBILE OPTIMIZATION (smartphone)
   - Evita i problemi di 100vh su mobile (barra indirizzi)
   - Layout più usabile senza cambiare JS (solo CSS)
========================================================= */
html, body { height: 100%; }
body { min-height: 100dvh; height: 100dvh; }
@supports not (height: 100dvh) {
  body { min-height: 100vh; height: 100vh; }
}

/* Su schermi piccoli: sidebar sopra e contenuto sotto (niente compressione orizzontale) */
@media (max-width: 768px) {
  #app-container { flex-direction: column !important; }

  #app-container > aside {
    width: 100% !important;
    max-width: 100% !important;
    height: auto !important;
    max-height: 45vh;
    overflow-y: auto;
    border-right: 0 !important;
    border-bottom: 1px solid rgba(148,163,184,0.35) !important;
  }

  main > header {
    height: auto !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    padding-top: 0.75rem !important;
    padding-bottom: 0.75rem !important;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  /* la “p-8” del contenuto principale su mobile è eccessiva */
  main > div.flex-1 {
    padding: 1rem !important;
  }
}

/* Modali: top più vicino e altezza reale su smartphone (senza toccare HTML/JS) */
@media (max-width: 640px) {
  .fixed.inset-0 > div.absolute.top-12 {
    top: 1rem !important;
    padding-left: 0.75rem !important;
    padding-right: 0.75rem !important;
  }

  .fixed.inset-0 > div.absolute.top-12 > div {
    max-height: calc(100dvh - 2rem) !important;
  }
}



/* =========================
   THEME LIGHT: COLOR REFRESH (no grigi)
   - Sostituisce grigi/slate con tinte azzurre/indigo coerenti col blu accent.
   - Aggiunge fix per classi Tailwind con slash (es: bg-deep/50).
   ========================= */
.theme-light{
  --lt-surface: #ffffff;
  --lt-panel: #eff6ff;        /* blue-50 */
  --lt-panel2: #dbeafe;       /* blue-100 */
  --lt-panel3: #bfdbfe;       /* blue-200 */
  --lt-border: #93c5fd;       /* blue-300 */
  --lt-border-strong: #60a5fa;/* blue-400 */
  --lt-muted: #1e3a8a;        /* blue-900 */
  --lt-muted2: #1d4ed8;       /* blue-700 */
}

/* --- Deep backgrounds con slash (usati in header e overlay) --- */
.theme-light .bg-deep\/50 { background-color: rgba(239,246,255,0.88) !important; }
.theme-light .bg-deep\/30 { background-color: rgba(239,246,255,0.70) !important; }
.theme-light .bg-deep\/20 { background-color: rgba(239,246,255,0.55) !important; }

/* Se esistono anche versioni senza slash già usate in CSS */
.theme-light .bg-deep50 { background-color: rgba(239,246,255,0.88) !important; }
.theme-light .bg-deep30 { background-color: rgba(239,246,255,0.70) !important; }
.theme-light .bg-deep20 { background-color: rgba(239,246,255,0.55) !important; }

/* Superfici “grigie” -> pannelli azzurri */
.theme-light .bg-slate-900\/50,
.theme-light .bg-slate-800\/50,
.theme-light .bg-slate-90050,
.theme-light .bg-slate-80050 {
  background-color: rgba(219,234,254,0.72) !important;
}
.theme-light .bg-slate-800\/30 { background-color: rgba(219,234,254,0.56) !important; }
.theme-light .bg-slate-800\/20 { background-color: rgba(219,234,254,0.42) !important; }

.theme-light .bg-slate-800 { background-color: var(--lt-panel2) !important; }
.theme-light .bg-slate-700 { background-color: var(--lt-panel3) !important; }
.theme-light .bg-slate-600 { background-color: #c7d2fe !important; } /* indigo-200 */

/* Hover “grigi” -> hover azzurro */
.theme-light .hover\:bg-slate-800:hover,
.theme-light .hover\:bg-slate-700:hover,
.theme-light .hover\:bg-slate-600:hover {
  background-color: rgba(191,219,254,0.88) !important;
}
.theme-light .hover\:bg-slate-800\/50:hover,
.theme-light .hover\:bg-slate-800\/30:hover,
.theme-light .hover\:bg-slate-900\/50:hover {
  background-color: rgba(191,219,254,0.82) !important;
}

/* Bordi (anche con slash) -> azzurri */
.theme-light .border-slate-800,
.theme-light .border-slate-700,
.theme-light .border-slate-600,
.theme-light .border-slate-500,
.theme-light .border-slate-80050,
.theme-light .border-slate-700\/50,
.theme-light .border-slate-800\/50 {
  border-color: var(--lt-border) !important;
}

/* Testi “grigi” -> blu/indigo (contrastati) */
.theme-light .text-slate-500 { color: var(--lt-muted) !important; }
.theme-light .text-slate-400 { color: var(--lt-muted2) !important; }
.theme-light .text-slate-300 { color: #0f172a !important; }

/* IMPORTANT: alcuni header/tabelle usano text-slate-200 (troppo chiaro su azzurro) */
.theme-light .text-slate-200,
.theme-light .text-slate-100,
.theme-light .text-slate-50 {
  color: #0f172a !important;
}

/* Placeholder */
.theme-light input::placeholder,
.theme-light textarea::placeholder {
  color: #1e40af !important; /* blue-800 */
  opacity: 0.85;
}

/* Tabelle: intestazioni leggibili (testo scuro su azzurro chiaro) */
.theme-light table thead,
.theme-light table thead th {
  background-color: rgba(191,219,254,0.92) !important;
  color: #0f172a !important;
}
.theme-light table thead * { color: #0f172a !important; }

/* Fix specifico: classi THEAD tailwind in markup */
.theme-light thead.bg-slate-900\/50,
.theme-light thead.bg-slate-90050 {
  background-color: rgba(191,219,254,0.92) !important;
}


/* =========================
   LIGHT THEME: SINISTRI (claims) readability
   ========================= */
.theme-light #section-claims table,
.theme-light #section-claims thead,
.theme-light #section-claims tbody,
.theme-light #section-claims th,
.theme-light #section-claims td {
  color: #0f172a !important;
}
.theme-light #section-claims thead {
  background-color: rgba(191,219,254,0.92) !important;
}
.theme-light #section-claims thead th {
  color: #0f172a !important;
}
.theme-light #section-claims tbody tr:hover {
  background-color: rgba(37,99,235,0.06) !important;
}


/* =========================
   FIX: Theme selector visibility (Settings modal) in LIGHT mode
   ========================= */
body.theme-light #settingsModal input[name="theme"] + div,
.theme-light #settingsModal input[name="theme"] + div{
  transition: all .15s ease-in-out;
}

body.theme-light #settingsModal input[name="theme"]:not(:checked) + div,
.theme-light #settingsModal input[name="theme"]:not(:checked) + div{
  background-color: rgba(219,234,254,0.85) !important;
  color: #0f172a !important;
  border-color: rgba(147,197,253,0.95) !important;
  opacity: 0.9;
}

body.theme-light #settingsModal input[name="theme"]:checked + div,
.theme-light #settingsModal input[name="theme"]:checked + div{
  background-color: #2563eb !important;
  color: #ffffff !important;
  border-color: #1d4ed8 !important;
  box-shadow: 0 0 0 3px rgba(37,99,235,0.25) !important;
  opacity: 1;
  position: relative;
}

body.theme-light #settingsModal input[name="theme"]:checked + div::after,
.theme-light #settingsModal input[name="theme"]:checked + div::after{
  content: "✓";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  font-weight: 900;
  color: #ffffff;
}


/* =========================
   THEME LIGHT: CALENDAR BLUE (no grigio)
   ========================= */
.theme-light .calendar-day-header{
  color: #1e3a8a !important; /* blue-900 */
}

.theme-light .calendar-cell{
  background-color: rgba(239,246,255,0.85) !important; /* blue-50 */
  border: 1px solid rgba(147,197,253,0.65) !important; /* blue-300 */
}

.theme-light .calendar-cell:hover{
  background-color: rgba(191,219,254,0.65) !important; /* blue-200 */
}

.theme-light .calendar-cell.today{
  background-color: rgba(37,99,235,0.10) !important; /* accent blue */
  border-color: rgba(37,99,235,0.45) !important;
}

.theme-light .calendar-cell.inactive{
  opacity: 0.65 !important;
  background-color: rgba(219,234,254,0.45) !important;
}


/* THEME LIGHT: from-accent/5 */
.theme-light .from-accent\/5{
  --tw-gradient-from: rgba(37,99,235,0.10) var(--tw-gradient-from-position) !important;
  --tw-gradient-to: rgba(37,99,235,0) var(--tw-gradient-to-position) !important;
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important;
}

</style>
</head>
<body class="bg-deep text-slate-300 font-sans antialiased h-screen flex flex-col overflow-hidden relative">

    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-accent/5 to-transparent pointer-events-none z-0"></div>

    <div id="auth-container" class="flex-1 flex items-center justify-center p-4 z-50 fade-in">
        <div class="w-full max-w-md bg-surface border border-slate-700 rounded-2xl shadow-2xl p-8 relative overflow-hidden">
            <div class="absolute -top-20 -right-20 w-40 h-40 bg-accent/20 blur-3xl rounded-full pointer-events-none"></div>
            <div class="text-center mb-8 flex flex-col items-center relative z-10">
                <svg class="w-20 h-20 mb-4 filter drop-shadow-[0_0_10px_rgba(226,255,0,0.3)]" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 5L90 25V75L50 95L10 75V25L50 5Z" stroke="#E2FF00" stroke-width="2" fill="rgba(226, 255, 0, 0.05)"/>
                    <path d="M50 20L75 35V65L50 80L25 65V35L50 20Z" fill="#E2FF00"/>
                    <path d="M50 20V50L75 65" stroke="#0B1121" stroke-width="4" stroke-linecap="round"/>
                    <path d="M50 50L25 65" stroke="#0B1121" stroke-width="4" stroke-linecap="round"/>
                </svg>
                <h1 class="text-4xl font-bold text-white tracking-widest">NEXA</h1>
                <p class="text-xl text-slate-500 font-signature mt-1">by EvanEsse</p>
                <p class="text-[10px] text-slate-600 uppercase tracking-widest mt-4">Accesso Riservato</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4 relative z-10">
                <div><label class="block text-xs text-slate-500 font-bold mb-1">Email</label><input type="email" id="loginEmail" required class="w-full bg-deep border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent" placeholder="tua@email.com"></div>
                <div><label class="block text-xs text-slate-500 font-bold mb-1">Password</label><input type="password" id="loginPass" required class="w-full bg-deep border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent" placeholder="••••••••"></div>
                <div class="flex items-center gap-2"><input type="checkbox" id="rememberMe" checked class="accent-accent bg-deep border-slate-700 h-4 w-4 rounded"><label for="rememberMe" class="text-xs text-slate-400 cursor-pointer">Resta connesso</label></div>
                <button type="submit" class="w-full py-3 rounded-xl bg-accent text-darktext font-bold hover:bg-yellow-400 shadow-lg shadow-accent/20 transition-all mt-4 uppercase tracking-wide">Accedi a NEXA</button>
                <div class="text-center mt-4"><p class="text-xs text-slate-400">Non hai un account? <a href="#" onclick="toggleAuthMode()" class="text-accent hover:underline font-bold">Registrati</a></p></div>
            </form>
            <form id="registerForm" onsubmit="handleRegister(event)" class="space-y-4 hidden relative z-10">
                <div class="grid grid-cols-2 gap-3"><div><label class="block text-xs text-slate-500 font-bold mb-1">Nome</label><input type="text" id="regName" required class="w-full bg-deep border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent"></div><div><label class="block text-xs text-slate-500 font-bold mb-1">Cognome</label><input type="text" id="regSurname" required class="w-full bg-deep border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent"></div></div>
                <div><label class="block text-xs text-slate-500 font-bold mb-1">Email</label><input type="email" id="regEmail" required class="w-full bg-deep border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent"></div>
                <div><label class="block text-xs text-slate-500 font-bold mb-1">Password</label><input type="password" id="regPass" required class="w-full bg-deep border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent"></div>
                <button type="submit" class="w-full py-3 rounded-xl bg-white text-deep font-bold hover:bg-gray-200 transition-all mt-4">Crea Account</button>
                <div class="text-center mt-4"><p class="text-xs text-slate-400">Hai già un account? <a href="#" onclick="toggleAuthMode()" class="text-accent hover:underline font-bold">Accedi</a></p></div>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden flex-1 flex overflow-hidden h-full w-full fade-in z-10">
        
        <aside class="w-72 bg-deep flex-shrink-0 flex flex-col border-r border-slate-800/50 p-4">
            <div class="bg-surface border border-slate-800 rounded-xl p-4 mb-8 shadow-lg shadow-accent/5 text-white relative overflow-hidden group cursor-default">
                <div class="absolute -top-10 -left-10 w-20 h-20 bg-accent/20 blur-3xl rounded-full group-hover:bg-accent/30 transition-all"></div>
                <div class="flex items-center gap-3 relative z-10">
                    <svg class="w-12 h-12 filter drop-shadow-[0_0_5px_rgba(226,255,0,0.5)]" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50 5L90 25V75L50 95L10 75V25L50 5Z" stroke="#E2FF00" stroke-width="4" fill="rgba(226, 255, 0, 0.1)"/>
                        <path d="M50 25L70 37V63L50 75L30 63V37L50 25Z" fill="#E2FF00"/>
                    </svg>
                    <div>
                        <h1 class="font-bold text-2xl tracking-widest leading-none">NEXA</h1>
                        <p class="text-slate-500 font-signature text-lg leading-none mt-1 -ml-1">by EvanEsse</p>
                    </div>
                </div>
                <p class="text-[9px] text-slate-500 mt-3 text-center border-t border-slate-800/50 pt-2 uppercase tracking-wider relative z-10">Portafoglio • Polizze • Titoli</p>
            </div>

            <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 px-2">Navigazione</div>
            <nav class="flex-1 space-y-3">
                <a href="#" onclick="switchSection('home')" id="nav-home" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-slate-800/50 hover:text-white group nav-active"><i class="fa-solid fa-house w-5 text-center"></i> <span class="font-medium">Home Dashboard</span></a>
                <a href="#" onclick="switchSection('agenda')" id="nav-agenda" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-slate-800/50 hover:text-white group"><i class="fa-regular fa-calendar-check w-5 text-center group-hover:text-accent transition-colors"></i> <span class="font-medium">Agenda & Calendario</span></a>
                <a href="#" onclick="switchSection('clients')" id="nav-clients" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-slate-800/50 hover:text-white group"><i class="fa-solid fa-users w-5 text-center group-hover:text-accent transition-colors"></i> <span class="font-medium">Anagrafica clienti</span></a>
                <a href="#" onclick="switchSection('contracts'); resetContractFilter(); renderContractsDefault();" id="nav-contracts" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-slate-800/50 hover:text-white group"><i class="fa-solid fa-file-contract w-5 text-center group-hover:text-accent transition-colors"></i> <span class="font-medium">Contratti / Polizze</span></a>
                
<a href="#" onclick="switchSection('claims'); renderClaims();" id="nav-claims" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-slate-80050 hover:text-white group">
  <i class="fa-solid fa-triangle-exclamation w-5 text-center group-hover:text-accent transition-colors"></i>
  <span class="font-medium">Sinistri</span>
</a>
<a href="#" onclick="switchSection('deadlines')" id="nav-deadlines" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-slate-800/50 hover:text-white group"><i class="fa-solid fa-calendar-days w-5 text-center group-hover:text-accent transition-colors"></i> <span class="font-medium">Scadenze titoli</span></a>
                    <a href="#" onclick="switchSection('report')" id="nav-report" class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-slate-800/50 hover:text-white group">
                        <i class="fa-solid fa-chart-pie w-5 text-center group-hover:text-accent transition-colors"></i>
                        <span class="font-medium">Report</span>
                    </a>
            </nav>

            <div class="mt-auto pt-4 border-t border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-2 px-2">Area Dati</p>
                <div class="space-y-2">
                    <button onclick="downloadBackup()" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg text-xs text-slate-300 hover:bg-slate-800 border border-slate-700 hover:border-accent transition-all">
                        <i class="fa-solid fa-download text-accent"></i> Esporta Archivio
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg text-xs text-slate-300 hover:bg-slate-800 border border-slate-700 hover:border-info transition-all">
                        <i class="fa-solid fa-upload text-info"></i> Importa Archivio
                    </button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="processImport(this)">
                    <button onclick="document.getElementById('legacyImportFile').click()" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg text-xs text-slate-300 hover:bg-slate-800 border border-slate-700 hover:border-warning transition-all">
                        <i class="fa-solid fa-file-csv text-warning"></i> Imp. Vecchio Gest.
                    </button>
                    <input type="file" id="legacyImportFile" class="hidden" accept=".json" onchange="processLegacyImport(this)">
                    
                    <button onclick="resetDatabase()" class="w-full flex items-center gap-3 px-4 py-2 rounded-lg text-xs text-red-400 hover:bg-red-900/30 border border-red-900/50 hover:border-red-500 transition-all mt-4">
                        <i class="fa-solid fa-trash-can"></i> RESETTA DATABASE
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden relative">
            <header class="h-20 flex items-center justify-between px-8 border-b border-slate-800/50 bg-deep/50 backdrop-blur-sm z-10 flex-shrink-0">
                <div><h2 class="text-xl font-bold text-white" id="page-title">Dashboard</h2><p class="text-xs text-slate-500" id="page-subtitle">Panoramica</p></div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block"><p class="text-sm font-bold text-white" id="user-display-name">User</p></div>
                    <div class="w-10 h-10 rounded-full bg-surface flex items-center justify-center border border-accent/30 shadow-lg shadow-accent/10 text-accent font-bold text-lg" id="user-avatar" onclick="openAvatarPicker()" title="Cambia avatar" role="button" style="cursor:pointer;">U</div>
                    <button onclick="openSettingsModal()" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 hover:bg-slate-700 transition-all text-slate-400" title="Impostazioni"><i class="fa-solid fa-gear"></i></button>
                    
        <button id="btn-manual-save" onclick="manualSaveAll(this)" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 hover:bg-slate-700 transition-all text-slate-400" title="Salva">
            <i class="fa-solid fa-floppy-disk"></i>
        </button>
<button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 hover:bg-red-900/50 hover:text-red-500 transition-all text-slate-400" title="Esci"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 z-10 relative scroll-smooth">
                
                <div id="section-home" class="fade-in space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-effect p-5 rounded-2xl border-l-4 border-accent relative overflow-hidden"><i class="fa-solid fa-users absolute right-4 top-4 text-6xl text-accent opacity-10"></i><p class="text-xs font-bold text-slate-500 uppercase">I Tuoi Clienti</p><h3 class="text-3xl font-bold text-white mt-1" id="dash-total-clients">0</h3></div>
                        <div class="glass-effect p-5 rounded-2xl border-l-4 border-warning relative overflow-hidden"><i class="fa-solid fa-file-contract absolute right-4 top-4 text-6xl text-warning opacity-10"></i><p class="text-xs font-bold text-slate-500 uppercase">Polizze Attive</p><h3 class="text-3xl font-bold text-white mt-1" id="dash-total-policies">0</h3></div>
                        <div class="glass-effect p-5 rounded-2xl border-l-4 border-danger relative overflow-hidden"><i class="fa-solid fa-circle-exclamation absolute right-4 top-4 text-6xl text-danger opacity-10"></i><p class="text-xs font-bold text-slate-500 uppercase">Da Incassare del mese</p><h3 class="text-3xl font-bold text-white mt-1" id="dash-pending-money">€ 0</h3></div>
                        <div class="glass-effect p-5 rounded-2xl border-l-4 border-success relative overflow-hidden"><i class="fa-solid fa-chart-line absolute right-4 top-4 text-6xl text-success opacity-10"></i><p class="text-xs font-bold text-slate-500 uppercase">Incassato (Mese)</p><h3 class="text-3xl font-bold text-white mt-1" id="dash-month-inc">€ 0</h3></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-effect rounded-2xl p-6 relative overflow-hidden flex flex-col h-[400px]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white"><i class="fa-regular fa-calendar-check text-accent mr-2"></i>Prossimi Appuntamenti</h3>
                                <button onclick="switchSection('agenda')" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-white border border-slate-600">Vedi Tutto</button>
                            </div>
                            <div class="overflow-y-auto flex-1 pr-2 space-y-2" id="dash-agenda-list"><p class="text-slate-500 text-xs text-center mt-10">Nessun appuntamento imminente.</p></div>
                        </div>
                        <div class="glass-effect rounded-2xl p-6 relative overflow-hidden h-[400px] flex flex-col">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fa-solid fa-cake-candles text-pink-500 mr-2"></i>Compleanni in Arrivo</h3>
                            <div class="overflow-y-auto flex-1 pr-2 space-y-2" id="dash-birthdays-list"><p class="text-slate-500 text-xs text-center mt-10">Nessun compleanno nei prossimi 30 giorni.</p></div>
                        </div>
                    </div>
                </div>

                <div id="section-agenda" class="hidden fade-in h-full flex flex-col">
                    <div class="glass-effect rounded-2xl p-6 shadow-2xl relative flex-1 flex flex-col">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div class="flex items-center gap-4"><h3 class="text-lg font-bold text-white uppercase tracking-wide">Agenda</h3><div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700"><button onclick="changeAgendaView('month')" id="btn-view-month" class="px-3 py-1 rounded text-xs font-bold text-white bg-slate-700">Mese</button><button onclick="changeAgendaView('week')" id="btn-view-week" class="px-3 py-1 rounded text-xs font-bold text-slate-400 hover:text-white">Settimana</button><button onclick="changeAgendaView('day')" id="btn-view-day" class="px-3 py-1 rounded text-xs font-bold text-slate-400 hover:text-white">Giorno</button></div></div>
                            <div class="flex items-center gap-3"><button onclick="agendaPrev()" class="w-8 h-8 rounded-full border border-slate-700 text-slate-400 hover:bg-slate-700"><i class="fa-solid fa-chevron-left"></i></button><span id="agenda-current-date-label" class="text-white font-bold min-w-[150px] text-center">Gennaio 2026</span><button onclick="agendaNext()" class="w-8 h-8 rounded-full border border-slate-700 text-slate-400 hover:bg-slate-700"><i class="fa-solid fa-chevron-right"></i></button><button onclick="agendaToday()" class="ml-2 text-xs border border-accent text-accent px-3 py-1 rounded hover:bg-accent hover:text-darktext">Oggi</button></div>
                            <button onclick="toggleNewEventForm()" class="bg-accent hover:bg-yellow-400 text-darktext px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-accent/20 flex gap-2"><i class="fa-solid fa-plus"></i> Nuovo</button>
                        </div>
                        <div id="newEventForm" class="hidden mb-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700 transition-all"><h4 class="text-white font-bold text-sm mb-3">Nuovo Appuntamento</h4><div class="grid grid-cols-1 md:grid-cols-4 gap-3"><input type="date" id="evtDate" class="bg-deep border border-slate-600 rounded px-3 py-2 text-sm text-white"><input type="time" id="evtTime" class="bg-deep border border-slate-600 rounded px-3 py-2 text-sm text-white"><input type="text" id="evtTitle" placeholder="Titolo / Cliente..." class="bg-deep border border-slate-600 rounded px-3 py-2 text-sm text-white md:col-span-2"></div><div class="flex justify-end gap-2 mt-3"><button onclick="toggleNewEventForm()" class="px-3 py-1 rounded text-slate-400 hover:text-white text-xs">Annulla</button><button onclick="addNewEvent()" class="px-4 py-2 bg-accent text-darktext font-bold rounded text-xs hover:bg-yellow-400">Salva</button></div></div>
                        <div id="calendar-container" class="flex-1 overflow-y-auto border border-slate-800 rounded-lg bg-deep/30"></div>
                    </div>
                </div>

                <div id="section-clients" class="hidden fade-in">
                    <div class="glass-effect rounded-2xl p-6 shadow-2xl relative">
                        <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-6 relative z-10"><div><h3 class="text-lg font-bold text-white uppercase tracking-wide">I Tuoi Clienti <span id="client-count" class="text-slate-500 text-sm normal-case ml-2">0</span></h3></div><div class="flex items-center gap-3"><input type="text" id="searchInput" onkeyup="searchClients()" placeholder="Cerca..." class="bg-deep/50 border border-slate-700 rounded-lg px-4 py-2 text-sm text-white focus:border-accent"><button onclick="openModal()" class="bg-accent hover:bg-yellow-400 text-darktext px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-accent/20 flex gap-2"><i class="fa-solid fa-plus"></i> Nuovo</button></div></div>
                        <div class="overflow-x-auto rounded-lg border border-slate-800"><table class="w-full text-left text-sm text-slate-400"><thead class="bg-slate-900/50 text-slate-200 uppercase text-xs font-bold tracking-wider"><tr><th class="px-6 py-4">Cliente</th><th class="px-6 py-4">CF</th><th class="px-6 py-4">Contatti</th><th class="px-6 py-4 text-right">Azioni</th></tr></thead><tbody id="clientsTableBody" class="divide-y divide-slate-800/50"></tbody></table></div>
                    </div>
                </div>

                <div id="section-contracts" class="hidden fade-in">
                    <div class="glass-effect rounded-2xl p-6 shadow-2xl relative">
                        <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-6">
                            <div><h3 class="text-lg font-bold text-white uppercase tracking-wide">Polizze & Contratti <span id="policy-count" class="text-slate-500 text-sm normal-case ml-2">0</span></h3><p class="text-sm text-slate-400 mt-1" id="contract-subtitle">Gestione portafoglio.</p></div>
                            <div class="flex items-center gap-3"><button onclick="resetContractFilter(true)" id="btn-show-all-contracts" class="hidden border border-accent text-accent hover:bg-accent hover:text-darktext px-4 py-2 rounded-lg text-sm transition-all"><i class="fa-solid fa-list mr-2"></i>Mostra Tutto</button><button onclick="switchSection('clients')" class="border border-slate-700 text-slate-400 hover:text-white px-4 py-2 rounded-lg text-sm transition-all"><i class="fa-solid fa-arrow-left mr-2"></i>Indietro</button><button onclick="openPolicyModalWithFilter()" class="bg-accent hover:bg-yellow-400 text-darktext px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-accent/20 flex gap-2"><i class="fa-solid fa-file-circle-plus"></i> Nuova Polizza</button>
                <div>
                    <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">N° Polizza</label>
                    <input type="text" id="searchPolicyNumber" onkeyup="searchPoliciesByNumber()" placeholder="Es. 123456..."
                           class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white w-44">
                </div>
</div>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-slate-800"><table class="w-full text-left text-sm text-slate-400"><thead class="bg-slate-900/50 text-slate-200 uppercase text-xs font-bold tracking-wider"><tr><th class="px-6 py-4">Stato</th><th class="px-6 py-4">Cliente</th><th class="px-6 py-4">Compagnia (Polizza)</th><th class="px-6 py-4">Scadenza</th><th class="px-6 py-4 text-right">Premio Annuo</th><th class="px-6 py-4 text-center">Azioni</th></tr></thead><tbody id="policiesTableBody" class="divide-y divide-slate-800/50"></tbody></table></div>
                    </div>
                </div>

                <div id="section-deadlines" class="hidden fade-in">
                    <div class="glass-effect rounded-2xl p-6 shadow-2xl relative">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div><h3 class="text-lg font-bold text-white uppercase tracking-wide">Scadenze Titoli <span class="text-slate-500 text-sm normal-case ml-2" id="deadlines-count">0</span></h3></div>
                        </div>
                        
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-6 flex items-end gap-4 shadow-lg">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1 font-bold uppercase"><i class="fa-solid fa-calendar-plus mr-1 text-accent"></i>Genera Rinnovi per:</label>
                                <input type="month" id="bulkRenewalInput" class="bg-deep border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:border-accent outline-none">
                            </div>
                            <button onclick="generateBulkRenewals()" class="bg-accent text-darktext px-4 py-2 rounded-lg text-sm font-bold hover:bg-yellow-400 transition-all flex items-center gap-2 shadow-lg shadow-accent/10">
                                <i class="fa-solid fa-arrows-rotate"></i> Genera
                            </button>
                            <div class="text-[10px] text-slate-500 max-w-xs leading-tight ml-2 border-l border-slate-700 pl-3 py-1">
                                Seleziona il mese target (es. Gen 2027). Il sistema cercherà le polizze scadute nello stesso mese e creerà i rinnovi con importo zero.
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row justify-between items-end mb-4 border-t border-slate-800 pt-4">
                            <div class="bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700 flex flex-wrap gap-4 text-xs mb-3 md:mb-0">
                                <span class="text-slate-400">Tot. Importo: <b class="text-white text-sm" id="deadlines-total-amount">€ 0.00</b></span>
                                <span class="text-slate-400 border-l border-slate-600 pl-4">Tot. Provvigioni: <b class="text-accent text-sm" id="deadlines-total-comm">€ 0.00</b></span>
                            </div>
                            
                            <div class="flex gap-2 flex-wrap justify-end items-end">
                                <div><button onclick="exportDeadlinesPDF()" class="bg-slate-700 hover:bg-slate-600 text-white border border-slate-600 rounded px-3 py-1.5 text-xs font-bold mr-2 mb-1 flex items-center gap-2"><i class="fa-solid fa-file-pdf text-red-400"></i> Esporta PDF (A4)</button></div>
                                <div><label class="block text-[10px] uppercase font-bold text-slate-500 ml-1 mb-1">Scadenza:</label><input type="month" id="filterMonthDeadlines" onchange="renderDeadlines()" class="bg-deep border border-slate-700 rounded px-2 py-1 text-xs text-white w-32"></div>
                                <div><label class="block text-[10px] uppercase font-bold text-slate-500 ml-1 mb-1">Incassati il:</label><input type="month" id="filterPayDateDeadlines" onchange="renderDeadlines()" class="bg-deep border border-slate-700 rounded px-2 py-1 text-xs text-accent border-accent/50 w-32"></div>
                                <div><label class="block text-[10px] uppercase font-bold text-slate-500 ml-1 mb-1">Stato:</label><select id="filterStatusDeadlines" onchange="renderDeadlines()" class="bg-deep border border-slate-700 rounded px-2 py-1 text-xs text-white"><option value="">Tutti gli stati</option><option value="DA INCASSARE">Da Incassare del mese</option><option value="INCASSATO">Incassati</option></select></div>
                                <div><label class="block text-[10px] uppercase font-bold text-slate-500 ml-1 mb-1">Compagnia:</label><select id="filterCompDeadlines" onchange="renderDeadlines()" class="bg-deep border border-slate-700 rounded px-2 py-1 text-xs text-white"><option value="">Tutte</option><option value="ALLIANZ">ALLIANZ</option><option value="HDI">HDI</option><option value="VITTORIA">VITTORIA</option><option value="HELVETIA">HELVETIA</option><option value="GENIALPIU">GENIALPIU</option><option value="ARAG">ARAG</option><option value="METLIFE">METLIFE</option>
</select></div>
                            </div>
                        </div>

                        <div class="overflow-x-auto rounded-lg border border-slate-800"><table class="w-full text-left text-sm text-slate-400"><thead class="bg-slate-900/50 text-slate-200 uppercase text-xs font-bold tracking-wider"><tr><th class="px-6 py-4">Scadenza</th><th class="px-6 py-4">Cliente / Polizza</th><th class="px-6 py-4">Rata N°</th><th class="px-6 py-4">Importo</th><th class="px-6 py-4 text-accent">Provvigioni</th><th class="px-6 py-4">Stato</th><th class="px-6 py-4 text-right">Azioni</th></tr></thead><tbody id="deadlinesTableBody" class="divide-y divide-slate-800/50"></tbody></table></div>
                    </div>
                </div>

    

            
<div id="section-claims" class="hidden fade-in">
  <div class="glass-effect rounded-2xl p-6 shadow-2xl relative">
    <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-6">
      <div>
        <h3 class="text-lg font-bold text-white uppercase tracking-wide">Sinistri</h3>
        <p class="text-sm text-slate-400 mt-1">Archivio sinistri con filtri e storico aggiornamenti.</p>
      </div>

      <div class="flex flex-wrap items-end gap-2">
        <div>
          <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Stato</label>
          <select id="filterClaimStatus" onchange="renderClaims()" class="bg-deep border border-slate-700 rounded px-2 py-1 text-xs text-white">
            <option value="APERTI">Sinistri aperti</option>
            <option value="CHIUSI">Sinistri chiusi</option>
            <option value="TUTTI">Tutti</option>
          </select>
        </div>

        <div>
          <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Mese</label>
          <select id="filterClaimMonth" onchange="renderClaims()" class="bg-deep border border-slate-700 rounded px-2 py-1 text-xs text-white w-28"></select>
        </div>

        <div>
          <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Anno</label>
          <select id="filterClaimYear" onchange="renderClaims()" class="bg-deep border border-slate-700 rounded px-2 py-1 text-xs text-white w-24"></select>
        </div>

        <div>
          <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Cerca</label>
          <input id="searchClaims" onkeyup="renderClaims()" placeholder="Polizza, sinistro, cliente..." class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white w-56" />
        </div>

        <button onclick="openClaimModal(null, null)" class="bg-accent hover:bg-yellow-400 text-darktext px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-accent20 flex gap-2">
          <i class="fa-solid fa-plus"></i> Nuovo
        </button>
      </div>
    </div>

    <div class="overflow-x-auto rounded-lg border border-slate-800">
      <table class="w-full text-left text-sm text-slate-400">
        <thead class="bg-slate-90050 text-slate-200 uppercase text-xs font-bold tracking-wider">
          <tr>
            <th class="px-6 py-4">Stato</th>
            <th class="px-6 py-4">Polizza</th>
            <th class="px-6 py-4">Compagnia</th>
            <th class="px-6 py-4">Cliente</th>
            <th class="px-6 py-4">N. sinistro</th>
            <th class="px-6 py-4">Data apertura</th>
            <th class="px-6 py-4">Ultimo aggiornamento</th>
            <th class="px-6 py-4">Note</th>
            <th class="px-6 py-4 text-center">Chiuso</th>
            <th class="px-6 py-4 text-right">Azioni</th>
          </tr>
        </thead>
        <tbody id="claimsTableBody" class="divide-y divide-slate-80050"></tbody>
      </table>
    </div>
  </div>
</div>
<div id="section-report" class="hidden fade-in">
                <div class="glass-effect rounded-2xl p-6 shadow-2xl relative">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-white uppercase tracking-wide">Report <span class="text-accent text-xs font-bold">(V18)</span></h3>
                            <p class="text-sm text-slate-400 mt-1">Analisi produzione, portafoglio e polizze perse.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="extractReport()" class="bg-accent hover:bg-accent/90 text-darktext border border-accent rounded px-4 py-2 text-sm font-bold flex items-center gap-2">
                                <i class="fa-solid fa-arrow-down-to-line"></i>Estrai
                            </button>
                            <button onclick="exportReportPDF()" class="bg-slate-700 hover:bg-slate-600 text-white border border-slate-600 rounded px-4 py-2 text-sm font-bold flex items-center gap-2">
                                <i class="fa-solid fa-file-pdf text-danger"></i>Esporta PDF
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-6 flex flex-col gap-4">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <div>
                                <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Tipo</label>
                                <select id="reportType" onchange="renderReport()" class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white w-full">
                                    <option value="PROD">Nuova Produzione</option>
                                    <option value="LOST">Polizze Perse</option>
                                    <option value="PORT">Portafoglio</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Anno</label>
                                <select id="reportYear" onchange="renderReport()" class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white w-full"><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option><option value="2031">2031</option><option value="2032">2032</option><option value="2033">2033</option><option value="2034">2034</option><option value="2035">2035</option><option value="2036">2036</option><option value="2037">2037</option><option value="2038">2038</option><option value="2039">2039</option><option value="2040">2040</option><option value="2041">2041</option><option value="2042">2042</option><option value="2043">2043</option><option value="2044">2044</option><option value="2045">2045</option><option value="2046">2046</option><option value="2047">2047</option><option value="2048">2048</option><option value="2049">2049</option><option value="2050">2050</option></select>
                            </div>
                            <div>
                                <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Mese</label>
                                <select id="reportMonth" onchange="renderReport()" class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white w-full">
                                    <option value="01">Gennaio</option>
                                    <option value="02">Febbraio</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Aprile</option>
                                    <option value="05">Maggio</option>
                                    <option value="06">Giugno</option>
                                    <option value="07">Luglio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Settembre</option>
                                    <option value="10">Ottobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">Dicembre</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center gap-2 text-xs text-slate-300 select-none">
                                    <input type="checkbox" id="reportCompare" checked onchange="renderReport()" class="accent-accent" />
                                    <span>Confronta anno prec.</span>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Macro Ramo</label>
                                <select id="reportRamo" onchange="renderReport()" class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white w-full">
                                    <option value="TUTTI">Tutti</option>
                                    <option value="AUTO">AUTO</option>
                                    <option value="RAMI VARI">RAMI VARI</option>
                                    <option value="VITA">VITA</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-10px uppercase font-bold text-slate-500 ml-1 mb-1">Compagnia</label>
                                <select id="reportCompany" onchange="renderReport()" class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white w-full"><option value="TUTTE">Tutte</option><option value="ALLIANZ">ALLIANZ</option><option value="HDI">HDI</option><option value="VITTORIA">VITTORIA</option><option value="GENIALPIU">GENIALPIU</option><option value="HELVETIA">HELVETIA</option><option value="ARAG">ARAG</option><option value="METLIFE">METLIFE</option><option value="ALTRE">ALTRE</option></select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="glass-effect p-4 rounded-2xl border-l-4 border-accent"><div class="text-xs text-slate-500 font-bold uppercase">N° Polizze</div><div class="text-3xl font-bold text-white mt-1" id="repCount">0</div></div>
                        <div class="glass-effect p-4 rounded-2xl border-l-4 border-success"><div class="text-xs text-slate-500 font-bold uppercase">Premi Totali</div><div class="text-3xl font-bold text-white mt-1" id="repPremium">€ 0.00</div></div>
                        <div class="glass-effect p-4 rounded-2xl border-l-4 border-warning"><div class="text-xs text-slate-500 font-bold uppercase">Δ vs anno prec.</div><div class="text-3xl font-bold text-white mt-1" id="repDelta">—</div></div>
                        <div class="glass-effect p-4 rounded-2xl border-l-4 border-info"><div class="text-xs text-slate-500 font-bold uppercase">Δ %</div><div class="text-3xl font-bold text-white mt-1" id="repDeltaPerc">—</div></div>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-slate-800">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-900/50 text-slate-200 uppercase text-xs font-bold tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">Cliente</th>
                                    <th class="px-6 py-4">Ramo</th>
                                    <th class="px-6 py-4">Compagnia</th>
                                    <th class="px-6 py-4">Polizza</th>
                                    <th class="px-6 py-4">Effetto</th>
                                    <th class="px-6 py-4">Scadenza</th>
                                    <th class="px-6 py-4 text-right">Premio</th>
                                    <th class="px-6 py-4">Stato</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="divide-y divide-slate-800/50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-placeholder" class="hidden fade-in"><div class="flex flex-col items-center justify-center h-96 text-center"><div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6"><i class="fa-solid fa-person-digging text-3xl text-slate-500"></i></div><h3 class="text-2xl font-bold text-white mb-2">Sezione in Sviluppo</h3><p class="text-slate-400 max-w-md">Funzionalità: <span id="placeholder-name" class="text-accent"></span></p></div></div>
            </div>
        </main>
    </div>

    <div id="clientModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl">
            <div class="bg-surface border border-slate-700 rounded-2xl shadow-2xl p-8 relative max-h-[90vh] overflow-y-auto border-t-4 border-t-accent">
                <div class="flex justify-between items-start mb-6"><div><h3 id="modalTitle" class="text-xl font-bold text-white">Nuova Anagrafica</h3></div><button onclick="closeModal()" class="text-slate-500 hover:text-accent"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                <form id="clientForm" onsubmit="saveClient(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4"><input type="text" id="inputName" required class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white" placeholder="Cognome Nome"><input type="text" id="inputCF" required oninput="parseCF()" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white uppercase" placeholder="Codice Fiscale"><input type="email" id="inputEmail" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white" placeholder="Email"><input type="tel" id="inputPhone" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white" placeholder="Telefono"></div>
                        <div class="space-y-4"><div class="bg-slate-800/30 p-2 rounded-lg border border-slate-700/50"><label class="block text-xs text-slate-400 mb-1 ml-1">Data di Nascita</label><input type="date" id="inputBirthDate" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm"></div><input type="text" id="inputAddress" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white" placeholder="Residenza"><div class="bg-slate-800/30 p-3 rounded-lg border border-slate-700/50"><label class="block text-xs text-slate-400 mb-1">Parente</label><div class="flex gap-2"><select id="relationSelect" class="w-2/3 bg-deep border border-slate-700 rounded-lg px-2 py-2 text-white text-xs"><option value="">Nessuno</option></select><select id="relationType" class="w-1/3 bg-deep border border-slate-700 rounded-lg px-2 py-2 text-white text-xs"><option value="Coniuge">Coniuge</option><option value="Figlio/a">Figlio/a</option><option value="Genitore">Genitore</option><option value="Socio">Socio</option></select></div></div><textarea id="inputNotes" rows="3" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" placeholder="Note..."></textarea></div>
                    </div>
                    <div class="flex gap-3 mt-8 pt-4 border-t border-slate-800"><button type="button" onclick="closeModal()" class="flex-1 px-4 py-3 rounded-xl border border-slate-700 text-slate-300">Annulla</button><button type="submit" id="submitBtn" class="flex-1 px-4 py-3 rounded-xl bg-accent text-darktext font-bold hover:bg-yellow-400">Salva</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="policyModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closePolicyModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl">
            <div class="bg-surface border border-slate-700 rounded-2xl shadow-2xl p-8 relative max-h-[90vh] overflow-y-auto border-t-4 border-t-accent">
                <div class="flex justify-between items-start mb-6"><div><h3 class="text-xl font-bold text-white" id="polModalTitle">Gestione Polizza</h3>
<div class=\"mt-3\">
  <button type=\"button\" onclick=\"openClaimModal(editingPolicyId || currentViewingPolicyId || null, null)\"
          class=\"text-xs bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded-lg text-white border border-slate-600\">
    <i class=\"fa-solid fa-triangle-exclamation mr-2 text-warning\"></i>Apri sinistro
  </button>
</div></div><button onclick="closePolicyModal()" class="text-slate-500 hover:text-accent"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                <form id="policyForm" onsubmit="savePolicy(event)">
                    <div class="mb-6"><label class="block text-xs text-slate-500 font-bold mb-1">Contraente *</label><select id="polClientSelect" required class="w-full bg-deep border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-accent"><option value="">Seleziona...</option></select></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="space-y-4">
                            <h4 class="text-accent text-xs font-bold uppercase border-b border-slate-800 pb-2">Dati Contratto</h4>
                            <div><label class="block text-xs text-slate-500 font-bold mb-1">Ramo *</label><div class="flex gap-2"><label class="cursor-pointer"><input type="radio" name="ramo" value="AUTO" class="peer hidden" onchange="updateCommDefaults()"><span class="peer-checked:bg-blue-600 peer-checked:text-white px-3 py-1 rounded-md bg-slate-800 text-slate-400 text-xs border border-slate-700 block text-center">AUTO</span></label><label class="cursor-pointer"><input type="radio" name="ramo" value="RAMI VARI" class="peer hidden" onchange="updateCommDefaults()"><span class="peer-checked:bg-orange-500 peer-checked:text-white px-3 py-1 rounded-md bg-slate-800 text-slate-400 text-xs border border-slate-700 block text-center">VARI</span></label><label class="cursor-pointer"><input type="radio" name="ramo" value="VITA" class="peer hidden" onchange="updateCommDefaults()"><span class="peer-checked:bg-green-600 peer-checked:text-white px-3 py-1 rounded-md bg-slate-800 text-slate-400 text-xs border border-slate-700 block text-center">VITA</span></label></div></div>
                            <div><label class="block text-xs text-slate-500 font-bold mb-1">Compagnia *</label><select id="polCompany" onchange="checkCustomCompany()" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm"><option value="ALLIANZ">ALLIANZ</option><option value="HDI">HDI</option><option value="VITTORIA">VITTORIA</option><option value="HELVETIA">HELVETIA</option><option value="GENIALPIU">GENIALPIU</option><option value="ARAG">ARAG</option><option value="METLIFE">METLIFE</option>
<option value=\"ALTRO\">ALTRO...</option></select><input type="text" id="polCustomCompany" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm mt-2 hidden" placeholder="Inserisci nome compagnia..."></div>
                            <div><label class="block text-xs text-slate-500 font-bold mb-1">Numero Polizza *</label><input type="text" id="polNumber" required class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm uppercase" placeholder="Es. 123456789"></div>
                            <div><label class="block text-xs text-slate-500 font-bold mb-1">Provvigioni Pers. (%)</label><input type="number" id="polCommPerc" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-accent font-bold" placeholder="35" oninput="generateInstallmentPreview()"></div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-accent text-xs font-bold uppercase border-b border-slate-800 pb-2">Durata & Pagamento</h4>
                            <div class="grid grid-cols-2 gap-2"><div><label class="block text-xs text-slate-500 font-bold mb-1">Effetto</label><input type="date" id="polEffectDate" required class="w-full bg-deep border border-slate-700 rounded-lg px-2 py-2 text-white text-sm"></div><div><label class="block text-xs text-slate-500 font-bold mb-1">Scadenza</label><input type="date" id="polExpiryDate" required class="w-full bg-deep border border-slate-700 rounded-lg px-2 py-2 text-white text-sm"></div></div>
                            <div><label class="block text-xs text-slate-500 font-bold mb-1">Frazionamento *</label><select id="polSplit" onchange="generateInstallmentPreview()" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm"><option value="1">Annuale</option><option value="2">Semestrale</option><option value="3">Quadrimestrale</option><option value="4">Trimestrale</option><option value="12">Mensile</option><option value="0">Premio Unico</option></select></div>
                            <div><label class="block text-xs text-slate-500 font-bold mb-1">Premio Annuale (€)</label><input type="number" step="0.01" id="polAnnualPremium" oninput="generateInstallmentPreview()" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm font-mono text-right" placeholder="0.00"></div>
                            <div><label class="block text-xs text-slate-500 font-bold mb-1">Note / Descrizione</label><textarea id="polNotes" rows="2" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm"></textarea></div>
                        </div>
                        <div class="bg-slate-800/20 rounded-lg p-3 border border-slate-700">
                            <h4 class="text-accent text-xs font-bold uppercase pb-2">Preview Rate & Provv.</h4>
                            <div id="titlesPreview" class="space-y-2 max-h-48 overflow-y-auto text-xs"><p class="text-slate-500 italic">Inserisci dati...</p></div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-8 pt-4 border-t border-slate-800"><button type="button" onclick="closePolicyModal()" class="flex-1 px-4 py-3 rounded-xl border border-slate-700 text-slate-300">Annulla</button><button type="submit" class="flex-1 px-4 py-3 rounded-xl bg-accent text-darktext font-bold hover:bg-yellow-400">Salva e Genera</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="policyTitlesModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closePolicyTitles()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-5xl">
            <div class="bg-surface border border-slate-700 rounded-2xl shadow-2xl p-6 relative">
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-3"><h3 class="text-lg font-bold text-white"><i class="fa-solid fa-list-ol mr-2 text-accent"></i>Dettaglio Rate & Provvigioni</h3><button onclick="closePolicyTitles()" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button></div>
                <div class="overflow-x-auto max-h-[60vh]">
                    <table class="w-full text-left text-sm text-slate-400">
                        <thead class="bg-slate-900/50 text-slate-200 text-xs uppercase font-bold sticky top-0"><tr><th>Scadenza</th><th>Rata</th><th>Importo</th><th>Provv. Totali</th><th>Provv. Pers.</th><th>Stato</th><th class="text-right">Azioni</th></tr></thead>
                        <tbody id="policyTitlesBody" class="divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closePaymentModal()"></div><div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm"><div class="bg-surface border border-slate-700 rounded-2xl shadow-2xl p-6 relative border-t-4 border-t-success"><h3 class="text-lg font-bold text-white mb-4"><i class="fa-solid fa-coins text-success mr-2"></i>Registra Incasso</h3><input type="hidden" id="payPolicyId"><input type="hidden" id="payTitleId"><div class="space-y-4"><div><label class="block text-xs text-slate-500 font-bold mb-1">Data</label><input type="date" id="payDate" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white"></div><div><label class="block text-xs text-slate-500 font-bold mb-1">Metodo</label><select id="payMethod" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white"><option value="CONTANTI">CONTANTI</option><option value="POS">POS</option><option value="BONIFICO">BONIFICO</option><option value="ASSEGNO">ASSEGNO</option><option value="ONLINE">PAGAMENTO ONLINE</option><option value="SDD">SDD</option>
</select></div><button onclick="confirmPayment()" class="w-full py-2 bg-success text-white rounded-lg font-bold hover:bg-green-600 mt-4">Conferma</button></div></div></div></div>
<script type="module" id="supabase-init">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // TODO: inserisci qui i valori del progetto (Supabase -> Settings -> API)
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_PUBLIC_KEY";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  window.SB = supabase;
  window.SUPABASEREADY = true;
</script>

    <script>
        // AUTH: ora gestita da legacy (abbandonato locale)

        // =========================================
        // AUTH + DB: Supabase (sostituisce legacy)
        // =========================================

        async function sbWaitReady(timeoutMs = 15000){
            const start = Date.now();
            while(!window.SUPABASEREADY || !window.SB){
                if(Date.now() - start > timeoutMs) throw new Error('Supabase non pronto (timeout).');
                await new Promise(r => setTimeout(r, 50));
            }
        }

        async function sbGetUid(){
            await sbWaitReady();
            const { data, error } = await SB.auth.getUser();
            if(error) throw error;
            return data?.user?.id || null;
        }

        async function sbLoadAllData(){
            const uid = await sbGetUid();
            if(!uid) return;

            // Clients
            {
                const { data, error } = await SB.from('clients').select('*').order('id');
                if(error) throw error;
                clients = (data || []).map(r => ({
                    id: r.id,
                    name: r.name,
                    cf: r.cf || '',
                    phone: r.phone || '',
                    email: r.email || '',
                    address: r.address || '',
                    birthDate: r.birth_date ? String(r.birth_date) : (r.birthDate ? String(r.birthDate) : ''),
                    relation: r.relation || null,
                    notes: r.notes || ''
                }));
            }

            // Policies
            {
                const { data, error } = await SB.from('policies').select('*').order('id');
                if(error) throw error;
                policies = (data || []).map(r => ({
                    id: r.id,
                    clientId: r.client_id,
                    ramo: r.ramo || '',
                    company: r.company || '',
                    policyNumber: r.policy_number || '',
                    status: r.status || '',
                    effect: r.effect ? String(r.effect) : '',
                    expiry: r.expiry ? String(r.expiry) : '',
                    annualPremium: Number(r.annual_premium || 0),
                    commPerc: Number(r.comm_perc || 0),
                    split: r.split ? Number(r.split) : (r.frazionamento ? Number(r.frazionamento) : null),
                    notes: r.notes || '',
                    titles: []
                }));
            }

            // Titles
            {
                const { data, error } = await SB.from('titles').select('*').order('id');
                if(error) throw error;
                const byPolicy = new Map();
                (data || []).forEach(r => {
                    const arr = byPolicy.get(r.policy_id) || [];
                    arr.push({
                        id: r.id,
                        n: r.n,
                        dueDate: r.due_date ? String(r.due_date) : '',
                        amount: Number(r.amount || 0),
                        status: r.status || 'DA INCASSARE',
                        paymentDate: r.payment_date ? String(r.payment_date) : null,
                        paymentMethod: r.payment_method || ''
                    });
                    byPolicy.set(r.policy_id, arr);
                });
                policies.forEach(p => p.titles = byPolicy.get(p.id) || []);
            }

            // Appointments (agenda)
            {
                const { data, error } = await SB.from('appointments').select('*').order('date');
                if(error) throw error;
                appointments = (data || []).map(r => ({
                    id: r.id,
                    date: r.date ? String(r.date) : '',
                    time: r.time || '',
                    title: r.title || ''
                }));
            }

            renderClients();
            renderPolicies(currentActiveClientId, true);
            renderDeadlines();
            renderAgendaMain();
            updateDashboard();
        }

        // Salvataggio (upsert) con debounce
        let sbSaveTimer = null;

        function saveAllData_legacy_OLD(){
            if(!currentUser || !currentUser.uid) return;
            saveLocalBackup();
            clearTimeout(sbSaveTimer);
            sbSaveTimer = setTimeout(() => {
                manualSaveAll().catch(err => {
                    console.error('manualSaveAll', err);
                    alert('Errore salvataggio: ' + (err?.message || err));
                });
            }, 1200);
        }

        async function manualSaveAll(btn){
            if(!currentUser || !currentUser.uid) return alert('Nessun profilo attivo.');
            await sbWaitReady();

            const iconEl = btn ? btn.querySelector('i') : null;
            const prevClass = iconEl ? iconEl.className : '';

            try{
                if(iconEl) iconEl.className = 'fa-solid fa-spinner fa-spin';

                const uid = await sbGetUid();
                if(!uid) throw new Error('Nessun profilo attivo.');

                // Clients
                {
                    const rows = (clients||[]).map(c => ({
                        id: c.id,
                        user_id: uid,
                        name: c.name,
                        cf: c.cf || null,
                        phone: c.phone || null,
                        email: c.email || null,
                        address: c.address || null,
                        birth_date: c.birthDate || null,
                        relation: c.relation || null,
                        notes: c.notes || null,
                        updated_at: new Date().toISOString()
                    }));
                    const { error } = await SB.from('clients').upsert(rows, { onConflict: 'id' });
                    if(error) throw error;
                }

                // Policies
                {
                    const rows = (policies||[]).map(p => ({
                        id: p.id,
                        user_id: uid,
                        client_id: p.clientId,
                        ramo: p.ramo || null,
                        company: p.company || null,
                        policy_number: p.policyNumber || null,
                        status: p.status || null,
                        effect: p.effect || null,
                        expiry: p.expiry || null,
                        annual_premium: Number(p.annualPremium || 0),
                        comm_perc: Number(p.commPerc || 0),
                        split: (p.split !== undefined && p.split !== null) ? Number(p.split) : null,
                        notes: p.notes || null,
                        updated_at: new Date().toISOString()
                    }));
                    const { error } = await SB.from('policies').upsert(rows, { onConflict: 'id' });
                    if(error) throw error;
                }

                // Titles
                {
                    const rows = [];
                    (policies||[]).forEach(p => {
                        (p.titles||[]).forEach(t => {
                            rows.push({
                                id: t.id,
                                user_id: uid,
                                policy_id: p.id,
                                n: t.n || null,
                                due_date: t.dueDate || null,
                                amount: Number(t.amount || 0),
                                status: t.status || null,
                                payment_date: t.paymentDate || null,
                                payment_method: t.paymentMethod || null,
                                updated_at: new Date().toISOString()
                            });
                        });
                    });
                    const { error } = await SB.from('titles').upsert(rows, { onConflict: 'id' });
                    if(error) throw error;
                }

                // Appointments
                {
                    const rows = (appointments||[]).map(a => ({
                        id: a.id,
                        user_id: uid,
                        date: a.date || null,
                        time: a.time || null,
                        title: a.title || null,
                        updated_at: new Date().toISOString()
                    }));
                    const { error } = await SB.from('appointments').upsert(rows, { onConflict: 'id' });
                    if(error) throw error;
                }

                if(iconEl){
                    iconEl.className = 'fa-solid fa-check';
                    setTimeout(()=>{ iconEl.className = prevClass || 'fa-solid fa-floppy-disk'; }, 900);
                }
            }catch(e){
                console.error('manualSaveAll error', e);
                if(iconEl) iconEl.className = prevClass || 'fa-solid fa-floppy-disk';
                alert(e?.message ? e.message : 'Errore durante il salvataggio.');
            }
        }

        async function sbStartAuthListener(){
            await sbWaitReady();

            SB.auth.onAuthStateChange(async (_event, session) => {
                const user = session?.user || null;
                if(user){
                    currentUser = { uid: user.id, email: user.email, name: '', surname: '' };
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    await sbLoadAllData();
                    initApp();
                } else {
                    currentUser = null;
                    clients = []; policies = []; appointments = [];
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('auth-container').classList.remove('hidden');
                }
            });

            // trigger iniziale
            const { data } = await SB.auth.getSession();
            const session = data?.session || null;
            if(session?.user){
                currentUser = { uid: session.user.id, email: session.user.email, name: '', surname: '' };
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                await sbLoadAllData();
                initApp();
            }
        }
        // ==============================
        // STATE (Supabase-only)
        // ==============================
        let currentUser = null; // { uid, email, name, surname, avatarId, ... }
        let clients = [], policies = [], appointments = [];
        let currentActiveClientId = null;
        let editingClientId=null, editingPolicyId=null, currentViewingPolicyId=null;

        // AGENDA STATE
        let agendaView = 'month';
        let agendaRefDate = new Date();

        // =========================================
        // AUTH Supabase - funzioni globali per i form
        // =========================================
        async function handleRegister(e){
            e.preventDefault();
            await sbWaitReady();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const pass  = document.getElementById('regPass').value;
            if(!email || !pass) return alert('Email e password obbligatorie.');
            const { error } = await SB.auth.signUp({ email, password: pass });
            if(error) return alert('Errore registrazione: ' + error.message);
            alert('Registrazione completata. Ora effettua il login.');
        }

        async function handleLogin(e){
            e.preventDefault();
            await sbWaitReady();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const pass  = document.getElementById('loginPass').value;
            if(!email || !pass) return alert('Inserisci email e password');
            const { error } = await SB.auth.signInWithPassword({ email, password: pass });
            if(error) return alert('Credenziali non valide: ' + error.message);
        }

        async function handleLogout(){
            try{ if(typeof manualSaveAll === 'function') await manualSaveAll(); }catch(e){}
            await sbWaitReady();
            const { error } = await SB.auth.signOut();
            if(error) alert('Errore logout: ' + error.message);
        }

        document.addEventListener('DOMContentLoaded', async ()=>{
            try{
                await sbWaitReady();
                try{ document.getElementById('payDate').valueAsDate = new Date(); }catch(e){}
                try{ document.getElementById('evtDate').valueAsDate = new Date(); }catch(e){}
                await sbStartAuthListener();
            }catch(err){
                console.error(err);
                alert('Errore inizializzazione: ' + (err?.message || err));
            }
        });

function toggleAuthMode() { document.getElementById('loginForm').classList.toggle('hidden'); document.getElementById('registerForm').classList.toggle('hidden'); }

        // ==============================
        // IMPOSTAZIONI / TEMA
        // ==============================
        function themeStorageKey(){
            try{ return currentUser ? ('evanEsseTheme'+currentUser.uid) : 'evanEsseTheme'; }
            catch(e){ return 'evanEsseTheme'; }
        }
        function applyTheme(t){
            const root = document.documentElement;
            if(t==='light') root.classList.add('theme-light');
            else root.classList.remove('theme-light');
        }
        function loadTheme(){
            const t = localStorage.getItem(themeStorageKey()) || 'dark';
            applyTheme(t);
        }
        function setTheme(t){
            localStorage.setItem(themeStorageKey(), t);
            applyTheme(t);
            syncThemeUI();
        }
        function syncThemeUI(){
            const t = localStorage.getItem(themeStorageKey()) || 'dark';
            const r = document.querySelectorAll('input[name="theme"]');
            r.forEach(el => el.checked = (el.value === t));
        }
        function openSettingsModal(){
            const m = document.getElementById('settingsModal');
            if(!m) return;
            m.classList.remove('hidden');
            syncThemeUI();
        }
        function closeSettingsModal(){
            const m = document.getElementById('settingsModal');
            if(!m) return;
            m.classList.add('hidden');
        }

  const n = (profile?.name || "").trim();
  const s = (profile?.surname || "").trim();
  const full = `${n} ${s}`.trim();

  if (profile?.displayName && String(profile.displayName).trim()) return String(profile.displayName).trim();
  if (full) return full;

  return "User";
}

const AVATAR_PRESETS = [
            { id: 'A1', bg: '#0ea5e9', fg: '#ffffff', icon: 'fa-solid fa-user' },
            { id: 'A2', bg: '#6366f1', fg: '#ffffff', icon: 'fa-solid fa-user-tie' },
            { id: 'A3', bg: '#22c55e', fg: '#052e16', icon: 'fa-solid fa-user-doctor' },
            { id: 'A4', bg: '#f59e0b', fg: '#1f2937', icon: 'fa-solid fa-user-gear' },
            { id: 'A5', bg: '#ef4444', fg: '#ffffff', icon: 'fa-solid fa-user-ninja' },
            { id: 'A6', bg: '#8b5cf6', fg: '#ffffff', icon: 'fa-solid fa-user-astronaut' },
            { id: 'A7', bg: '#14b8a6', fg: '#042f2e', icon: 'fa-solid fa-shield-halved' },
            { id: 'A8', bg: '#e11d48', fg: '#ffffff', icon: 'fa-solid fa-heart' },
            { id: 'A9', bg: '#a3e635', fg: '#1f2937', icon: 'fa-solid fa-leaf' },
            { id: 'A10', bg: '#38bdf8', fg: '#0b1220', icon: 'fa-solid fa-car' },
            { id: 'A12', bg: '#34d399', fg: '#0b1220', icon: 'fa-solid fa-chart-line' },
            { id: 'A13', bg: '#f97316', fg: '#0b1220', icon: 'fa-solid fa-fire' },
            { id: 'A14', bg: '#60a5fa', fg: '#0b1220', icon: 'fa-solid fa-snowflake' },
            { id: 'A15', bg: '#c084fc', fg: '#0b1220', icon: 'fa-solid fa-bolt' },
            { id: 'A16', bg: '#fda4af', fg: '#0b1220', icon: 'fa-solid fa-mug-hot' },
            { id: 'A17', bg: '#fcd34d', fg: '#0b1220', icon: 'fa-solid fa-star' },
            { id: 'A18', bg: '#4ade80', fg: '#0b1220', icon: 'fa-solid fa-tree' },
            { id: 'A19', bg: '#93c5fd', fg: '#0b1220', icon: 'fa-solid fa-mountain' },
            { id: 'A20', bg: '#fca5a5', fg: '#0b1220', icon: 'fa-solid fa-paw' },
            { id: 'A21', bg: '#bef264', fg: '#0b1220', icon: 'fa-solid fa-fish' },
            { id: 'A22', bg: '#a78bfa', fg: '#0b1220', icon: 'fa-solid fa-ghost' },
            { id: 'A23', bg: '#22d3ee', fg: '#0b1220', icon: 'fa-solid fa-sailboat' },
            { id: 'A24', bg: '#fdba74', fg: '#0b1220', icon: 'fa-solid fa-plane' },
            { id: 'A25', bg: '#86efac', fg: '#0b1220', icon: 'fa-solid fa-graduation-cap' },
            { id: 'A26', bg: '#f9a8d4', fg: '#0b1220', icon: 'fa-solid fa-wand-magic-sparkles' },
            { id: 'A27', bg: '#67e8f9', fg: '#0b1220', icon: 'fa-solid fa-compass' },
            { id: 'A28', bg: '#fef08a', fg: '#0b1220', icon: 'fa-solid fa-sun' },
            { id: 'A29', bg: '#c7d2fe', fg: '#0b1220', icon: 'fa-solid fa-moon' },
            { id: 'A30', bg: '#94a3b8', fg: '#0b1220', icon: 'fa-solid fa-fingerprint' },
        ];

        function getAvatarPreset(id){
            if(!id) return null;
            return AVATAR_PRESETS.find(a => a.id === id) || null;
        }

        function applyAvatarToElement(el, avatarId, fallbackLetter){
            if(!el) return;
            const a = getAvatarPreset(avatarId);
            el.dataset.avatarId = avatarId || '';

            if(a){
                el.style.backgroundColor = a.bg;
                el.style.color = a.fg;
                el.style.borderColor = 'rgba(255,255,255,0.15)';
                el.innerHTML = `<i class="${a.icon}"></i>`;
            } else {
                el.style.backgroundColor = '';
                el.style.color = '';
                el.style.borderColor = '';
                el.innerText = (fallbackLetter || 'U').toUpperCase();
            }
        }

        function renderUserHeader(displayName, email, avatarId){
            const dnEl = document.getElementById('user-display-name');
            const avEl = document.getElementById('user-avatar');
            const safeName = displayName || 'User';
            const fallback = (String(safeName).trim().charAt(0) || (email ? String(email).charAt(0) : 'U'));

            if(dnEl) dnEl.innerText = safeName;
            if(avEl) applyAvatarToElement(avEl, avatarId, fallback);
        }

        function openAvatarPicker(){
            const m = document.getElementById('avatarModal');
            if(!m) return;
            m.classList.remove('hidden');
            renderAvatarGrid();
        }

        function closeAvatarPicker(){
            const m = document.getElementById('avatarModal');
            if(!m) return;
            m.classList.add('hidden');
        }

        function renderAvatarGrid(){
            const grid = document.getElementById('avatarGrid');
            if(!grid) return;
            const selected = currentUser?.avatarId || '';
            grid.innerHTML = '';
            AVATAR_PRESETS.forEach(a => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-12 h-12 rounded-full flex items-center justify-center border transition-all ' +
                    (a.id === selected ? 'border-accent shadow-lg shadow-accent20' : 'border-slate-700 hover:border-accent');
                btn.style.backgroundColor = a.bg;
                btn.style.color = a.fg;
                btn.innerHTML = `<i class="${a.icon}"></i>`;
                btn.onclick = () => selectAvatar(a.id);
                grid.appendChild(btn);
            });
        }

        async function selectAvatar(avatarId){
            try{
                if(!currentUser || !currentUser.uid) return;
                currentUser.avatarId = avatarId;

                }

                const dn = computeDisplayNameFromProfile({ displayName: currentUser.displayName, name: currentUser.name, surname: currentUser.surname }, { displayName: currentUser.displayName, email: currentUser.email });
                renderUserHeader(dn, currentUser.email, currentUser.avatarId);

                closeAvatarPicker();
            } catch(e){
                console.error('selectAvatar error', e);
                alert('Errore salvataggio avatar.');
            }
        }

function initApp() {
  loadTheme();

  const dn = (currentUser && currentUser.displayName) ? currentUser.displayName : (`${currentUser?.name || ""} ${currentUser?.surname || ""}`.trim());
  const safeName = dn || (currentUser?.email ? String(currentUser.email).split("@")[0] : "User");
  renderUserHeader(safeName, currentUser?.email || "");

  clients = clients || [];
  policies = policies || [];
  appointments = appointments || [];

  consolidateDuplicatePolicies();
  autoCollectSDDTitles();
  renderClients();
  updateDashboard();
  renderAgendaMain();
}

        


        // ==================================================
        // AUTO-INCASSO: SDD mensile (split==12) il giorno di scadenza
        // ==================================================
        function autoCollectSDDTitles(){
            try{
                if(!Array.isArray(policies) || policies.length===0) return;
                const now = new Date();
                const todayStr = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().split('T')[0];
                let changed = false;
                policies.forEach(p => {
                    if(p.status !== 'ATTIVA') return;
                    if(Number(p.split) !== 12) return;
                    (p.titles || []).forEach(t => {
                        if(t.status === 'DA INCASSARE' && String(t.dueDate) === todayStr){
                            t.status = 'INCASSATO';
                            t.paymentDate = t.dueDate ? String(t.dueDate) : todayStr;
                            t.paymentMethod = 'SDD';
                            changed = true;
                        }
                    });
                });
                if(changed){ saveAllData(); }
            } catch(e){ console.log('autoCollectSDDTitles error', e); }
        }

        function resetDatabase() {
            if(!currentUser){ alert('Nessun profilo attivo.'); return; }
            if(confirm("ATTENZIONE: questa operazione cancellerà SOLO i dati (clienti/polizze/agenda) del profilo attualmente loggato.")) {
                if(confirm("Sicuro al 100%?")) {
                    try{
                        localStorage.removeItem('evanEssedata'+currentUser.uid);
                        localStorage.removeItem('evanEssepolicies'+currentUser.uid);
                        localStorage.removeItem('evanEsseagenda'+currentUser.uid);
                        localStorage.removeItem('evanEsserecentClients'+currentUser.uid);
                        localStorage.removeItem('evanEsserecentPolicies'+currentUser.uid);
                    } catch(e){ console.log(e); }
                    clients = []; policies = []; appointments = [];
                    saveAllData();
                    alert('Dati del profilo cancellati.');
                    location.reload();
                }
            }
        }

        function switchSection(sectionName) {
            // safety: hide report when changing section
            try{ document.getElementById('section-report')?.classList.add('hidden'); document.getElementById('nav-report')?.classList.remove('nav-active'); } catch(e){}

            ['home', 'clients', 'contracts', 'deadlines', 'agenda'].forEach(id => { const el=document.getElementById(`section-${id}`); if(el)el.classList.add('hidden'); const nav=document.getElementById(`nav-${id}`); if(nav)nav.classList.remove('nav-active'); });
            if(sectionName==='home'){document.getElementById('section-home').classList.remove('hidden');document.getElementById('nav-home').classList.add('nav-active');updateDashboard();}
            else if(sectionName==='clients'){document.getElementById('section-clients').classList.remove('hidden');document.getElementById('nav-clients').classList.add('nav-active');renderClients();}
            else if(sectionName==='contracts'){document.getElementById('section-contracts').classList.remove('hidden');document.getElementById('nav-contracts').classList.add('nav-active');renderContractsDefault();}
            else if(sectionName==='deadlines'){
                document.getElementById('section-deadlines').classList.remove('hidden');
                document.getElementById('nav-deadlines').classList.add('nav-active');
                const fMoD = document.getElementById('filterMonthDeadlines');
                if(!fMoD.value) { const now = new Date(); fMoD.value = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}`; }
                renderDeadlines();
            }
            else if(sectionName==='report') {
                document.getElementById('section-report').classList.remove('hidden');
                document.getElementById('nav-report').classList.add('nav-active');
                document.getElementById('page-title').innerText='Report';
                document.getElementById('page-subtitle').innerText='Analisi Produzione, Portafoglio e Polizze Perse';
                initReportDefaults();
                renderReport();
            }
            else if(sectionName==='agenda'){
                document.getElementById('section-agenda').classList.remove('hidden');
                document.getElementById('nav-agenda').classList.add('nav-active');
                renderAgendaMain();
            }
        }

        function updateDashboard(){
            autoCollectSDDTitles();
            document.getElementById('dash-total-clients').innerText = clients.length;

            // Polizze attive: conteggio univoco per (cliente + numero polizza)
            const active = policies.filter(p => p.status === 'ATTIVA');
            const uniqKeys = new Set(active.map(p => `${p.clientId}|${String(p.policyNumber || '').toUpperCase().trim()}`));
            document.getElementById('dash-total-policies').innerText = uniqKeys.size;

            // Da incassare del mese: somma titoli DA INCASSARE con scadenza nel mese corrente
            let pendingMonth = 0;
            let monthInc = 0;
            const now = new Date();
            const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

            policies.forEach(p => {
                (p.titles || []).forEach(t => {
                    if(t.status === 'INCASSATO' && t.paymentDate){
                        const d = new Date(t.paymentDate);
                        if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()){
                            monthInc += safeParseFloat(t.amount);
                        }
                    }
                    if(p.status === 'ATTIVA' && t.status === 'DA INCASSARE' && t.dueDate && String(t.dueDate).startsWith(ym)){
                        pendingMonth += safeParseFloat(t.amount);
                    }
                });
            });

            document.getElementById('dash-pending-money').innerText = pendingMonth.toFixed(2);
            document.getElementById('dash-month-inc').innerText = monthInc.toFixed(2);

            // Dashboard Agenda Summary
            const l = document.getElementById('dash-agenda-list');
            l.innerHTML = '';
            const upcoming = appointments
                .filter(a => new Date(a.date) >= new Date(new Date().setHours(0,0,0,0)))
                .sort((a,b) => new Date(a.date + 'T' + (a.time||'00:00')) - new Date(b.date + 'T' + (b.time||'00:00')))
                .slice(0,3);

            if(upcoming.length === 0) {
                l.innerHTML = '<p class="text-slate-500 text-xs text-center mt-10">Nessun appuntamento imminente.</p>';
            } else {
                upcoming.forEach(a => {
                    l.innerHTML += `<div class="flex items-center justify-between p-2 rounded border bg-slate-800/30 border-slate-700">
                        <div class="flex-1">
                            <div class="text-xs text-accent font-bold">${new Date(a.date).toLocaleDateString()} ${a.time||''}</div>
                            <div class="text-sm text-white font-medium truncate">${a.title}</div>
                        </div>
                    </div>`;
                });
            }

            // Widget compleanni
            const bList = document.getElementById('dash-birthdays-list');
            bList.innerHTML = '';
            const today = new Date();
            today.setHours(0,0,0,0);

            let upcomingBirthdays = [];
            clients.forEach(c => {
                if(!c.birthDate) return;
                const bdate = new Date(c.birthDate);
                let nextBday = new Date(today.getFullYear(), bdate.getMonth(), bdate.getDate());
                if(nextBday < today) nextBday.setFullYear(today.getFullYear() + 1);

                const diffDays = Math.ceil((nextBday - today) / (1000*60*60*24));
                if(diffDays >= 0 && diffDays <= 30){
                    const age = nextBday.getFullYear() - bdate.getFullYear();
                    upcomingBirthdays.push({ name: c.name, date: nextBday, age, diffDays });
                }
            });

            upcomingBirthdays.sort((a,b) => a.diffDays - b.diffDays);
            if(upcomingBirthdays.length === 0){
                bList.innerHTML = '<p class="text-slate-500 text-xs text-center mt-10">Nessun compleanno nei prossimi 30 giorni.</p>';
            } else {
                upcomingBirthdays.forEach(b => {
                    const dayText = b.diffDays === 0 ? 'Oggi!' : (b.diffDays === 1 ? 'Domani' : ('Tra ' + b.diffDays + ' gg'));
                    const colorClass = b.diffDays === 0 ? 'text-accent font-bold' : 'text-slate-400';
                    bList.innerHTML += `<div class="flex items-center justify-between p-3 rounded-lg bg-slate-800/40 border border-slate-700/50 hover:bg-slate-800 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-pink-900/50 text-pink-400 flex items-center justify-center text-xs border border-pink-500/30">
                                <i class="fa-solid fa-cake-candles"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-white leading-none">${b.name}</div>
                                <div class="text-10px text-slate-500 mt-1">${b.date.getDate()} ${b.date.toLocaleString('it-IT', {month:'long'})} <span class="text-pink-400">${b.age} anni</span></div>
                            </div>
                        </div>
                        <div class="text-xs ${colorClass}">${dayText}</div>
                    </div>`;
                });
            }
        }

        // ==========================================
        // NUOVA LOGICA AGENDA
        // ==========================================
        function toggleNewEventForm(){document.getElementById('newEventForm').classList.toggle('hidden');}
        
        function addNewEvent(){
            const d=document.getElementById('evtDate').value, t=document.getElementById('evtTime').value, ti=document.getElementById('evtTitle').value; 
            if(!d||!ti)return alert("Dati mancanti"); 
            appointments.push({id:Date.now(),date:d,time:t,title:ti}); 
            saveAllData(); 
            renderAgendaMain(); 
            updateDashboard();
            toggleNewEventForm(); 
            document.getElementById('evtTitle').value='';
        }

        function deleteAppointment(id){
            if(confirm("Eliminare appuntamento?")){
                appointments=appointments.filter(a=>a.id!==id);
                saveAllData();
                renderAgendaMain();
                updateDashboard();
            }
        }

        function changeAgendaView(v) { agendaView = v; renderAgendaMain(); }
        function agendaToday() { agendaRefDate = new Date(); renderAgendaMain(); }
        function agendaPrev() {
            if(agendaView==='month') agendaRefDate.setMonth(agendaRefDate.getMonth()-1);
            else if(agendaView==='week') agendaRefDate.setDate(agendaRefDate.getDate()-7);
            else if(agendaView==='day') agendaRefDate.setDate(agendaRefDate.getDate()-1);
            renderAgendaMain();
        }
        function agendaNext() {
            if(agendaView==='month') agendaRefDate.setMonth(agendaRefDate.getMonth()+1);
            else if(agendaView==='week') agendaRefDate.setDate(agendaRefDate.getDate()+7);
            else if(agendaView==='day') agendaRefDate.setDate(agendaRefDate.getDate()+1);
            renderAgendaMain();
        }

        function renderAgendaMain() {
            const container = document.getElementById('calendar-container');
            const lbl = document.getElementById('agenda-current-date-label');
            const btns = ['month','week','day'];
            btns.forEach(b => {
                const el = document.getElementById('btn-view-'+b);
                if(agendaView===b) { el.classList.add('bg-slate-700', 'text-white'); el.classList.remove('text-slate-400'); }
                else { el.classList.remove('bg-slate-700', 'text-white'); el.classList.add('text-slate-400'); }
            });

            container.innerHTML = '';
            const todayStr = new Date().toISOString().split('T')[0];

            if(agendaView === 'month') {
                const year = agendaRefDate.getFullYear();
                const month = agendaRefDate.getMonth();
                lbl.innerText = new Date(year, month).toLocaleString('it-IT', { month: 'long', year: 'numeric' }).toUpperCase();

                const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                // Adjust for Monday start (0=Mon, 6=Sun)
                let startCol = firstDay === 0 ? 6 : firstDay - 1;

                let html = '<div class="grid grid-cols-7 h-full">';
                const days = ['LUN','MAR','MER','GIO','VEN','SAB','DOM'];
                days.forEach(d => html += `<div class="calendar-day-header p-2 border-b border-slate-700 bg-slate-800/30">${d}</div>`);

                // Empty cells
                for(let i=0; i<startCol; i++) html += `<div class="calendar-cell inactive"></div>`;

                // Days
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
                    const isToday = dateStr === todayStr;
                    const daysEvents = appointments.filter(a => a.date === dateStr);
                    
                    html += `<div class="calendar-cell ${isToday?'today':''}">
                        <div class="text-right text-xs text-slate-500 mb-1 ${isToday?'text-accent font-bold':''}">${i}</div>
                        <div class="space-y-1 overflow-y-auto max-h-[60px]">`;
                    
                    daysEvents.forEach(ev => {
                         html += `<div onclick="deleteAppointment(${ev.id})" title="${ev.time} - ${ev.title}" class="event-chip event-chip-gen">${ev.time} ${ev.title}</div>`;
                    });

                    html += `</div></div>`;
                }
                html += '</div>';
                container.innerHTML = html;

            } else if (agendaView === 'week') {
                // Find start of week (Monday)
                const startOfWeek = new Date(agendaRefDate);
                const day = startOfWeek.getDay() || 7; 
                if(day !== 1) startOfWeek.setHours(-24 * (day - 1));
                
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);

                lbl.innerText = `${startOfWeek.getDate()} - ${endOfWeek.getDate()} ${startOfWeek.toLocaleString('it-IT',{month:'long'}).toUpperCase()}`;

                let html = '<div class="grid grid-cols-7 h-full divide-x divide-slate-800">';
                
                for(let i=0; i<7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(d.getDate() + i);
                    const dateStr = d.toISOString().split('T')[0];
                    const isToday = dateStr === todayStr;
                    const daysEvents = appointments.filter(a => a.date === dateStr).sort((a,b) => (a.time||'').localeCompare(b.time||''));

                    html += `<div class="flex flex-col h-full bg-slate-900/20">
                        <div class="text-center py-2 border-b border-slate-700 ${isToday ? 'bg-accent/10' : 'bg-slate-800/30'}">
                            <div class="text-[10px] text-slate-500 uppercase">${d.toLocaleString('it-IT', {weekday:'short'})}</div>
                            <div class="text-sm font-bold ${isToday ? 'text-accent' : 'text-white'}">${d.getDate()}</div>
                        </div>
                        <div class="flex-1 p-2 space-y-2 overflow-y-auto">`;
                    
                    daysEvents.forEach(ev => {
                        html += `<div onclick="deleteAppointment(${ev.id})" class="p-2 rounded bg-slate-800 border border-slate-700 hover:border-accent cursor-pointer group">
                            <div class="text-xs text-accent font-bold">${ev.time}</div>
                            <div class="text-xs text-white break-words">${ev.title}</div>
                            <div class="hidden group-hover:block text-[10px] text-red-500 mt-1 text-right">Elimina</div>
                        </div>`;
                    });

                    html += `</div></div>`;
                }
                html += '</div>';
                container.innerHTML = html;

            } else if (agendaView === 'day') {
                lbl.innerText = agendaRefDate.toLocaleString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
                const dateStr = agendaRefDate.toISOString().split('T')[0];
                const daysEvents = appointments.filter(a => a.date === dateStr).sort((a,b) => (a.time||'').localeCompare(b.time||''));

                let html = '<div class="max-w-3xl mx-auto p-4 space-y-4">';
                if(daysEvents.length === 0) {
                    html += '<div class="text-center text-slate-500 mt-10">Nessun appuntamento per questo giorno.</div>';
                } else {
                    daysEvents.forEach(ev => {
                        html += `<div class="flex items-center gap-4 p-4 rounded-xl bg-slate-800/50 border border-slate-700">
                            <div class="text-xl font-mono text-accent font-bold">${ev.time}</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-lg">${ev.title}</div>
                            </div>
                            <button onclick="deleteAppointment(${ev.id})" class="text-slate-500 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
                        </div>`;
                    });
                }
                html += '</div>';
                container.innerHTML = html;
            }
        }

        function downloadBackup() { const data = { clients, policies, appointments, currentUser }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_evanesse_${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        async function processImport(input) { 
            const file = input.files[0]; 
            if (!file) return; 
            
            const reader = new FileReader(); 
            reader.onload = async function(e) { 
                try { 
                    const data = JSON.parse(e.target.result); 
                    
                    if (confirm("ATTENZIONE: Questa operazione sovrascriverà i dati attuali su legacy con quelli del backup.\n\nProcedere?")) { 
                        
                        // Mostra un indicatore di caricamento visivo
                        const importBtn = document.querySelector('button[onclick*="importFile"]');
                        if(importBtn) importBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Caricamento in corso...';

                        // 1. Carica i dati in memoria
                        clients = data.clients || []; 
                        policies = data.policies || []; 
                        appointments = data.appointments || []; 
                        
                        // 2. Forza la salvataggio immediato su Supabase e ATTENDI la fine
                        try {
                            // Disabilita i listener per evitare loop durante l'upload
                            
                            
                            await manualSaveAll();
                            
                            alert("Importazione completata con successo! I dati sono stati salvati su Supabase.");
                            location.reload(); 
                            if(importBtn) importBtn.innerHTML = '<i class="fa-solid fa-upload text-info"></i> Importa Archivio';
                            // Riavvia i listener in caso di errore
                            
                        }
                    } 
                } catch (err) { 
                    alert("Il file selezionato non è valido."); 
                    console.error(err);
                } 
            }; 
            reader.readAsText(file); 
        }
        function processLegacyImport(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const legacyData = JSON.parse(e.target.result); if (!Array.isArray(legacyData)) return alert("Formato non valido"); let newC=0, newP=0; const splitMap = { 'Annuale': 1, 'Semestrale': 2, 'Trimestrale': 4, 'Quadrimestrale': 3, 'Mensile': 12, 'Mensile con SDD': 12 }; legacyData.forEach(item => { let client = clients.find(c => (item.codiceFiscale && c.cf === item.codiceFiscale) || c.name === item.nomeCliente); if (!client) { client = { id: Date.now() + Math.floor(Math.random() * 1000), name: item.nomeCliente, cf: item.codiceFiscale || '', email: item.email || '', phone: item.cellulare || '', address: '', notes: item.linkedProfiles || '', relation: null, createdAt: new Date().toLocaleDateString('it-IT') }; clients.push(client); newC++; } const split = splitMap[item.frazionamento] || (item.isAnnual ? 1 : 2); const annual = parseFloat(item.premio) || 0; const comm = parseFloat(item.provvigioni) || 0; let ramo = 'RAMI VARI'; if(item.ramoPolizza && item.ramoPolizza.toUpperCase().includes('AUTO')) ramo = 'AUTO'; if(item.ramoPolizza && item.ramoPolizza.toUpperCase().includes('VITA')) ramo = 'VITA'; let titles = []; let count = (split === 1 ? 1 : split); let amt = annual / count; let expiryDate = new Date(item.dataScadenza); let effectDate = new Date(expiryDate); effectDate.setFullYear(effectDate.getFullYear() - 1); for(let i=0; i<count; i++){ let titleDate = new Date(item.dataScadenza); titleDate.setFullYear(titleDate.getFullYear() - 1); if(i > 0) titleDate.setMonth(titleDate.getMonth() + (12/count * i)); let status = 'DA INCASSARE'; let pDate = null; if(item.pagato && i===0) { status = 'INCASSATO'; pDate = item.dataIncasso; } titles.push({ id: Date.now() + Math.floor(Math.random()*1000000), n: i+1, dueDate: toISODateLocal(titleDate), amount: amt, status: status, commTotal: comm, commPers: comm * 0.35, paymentDate: pDate }); } const newPol = { id: Date.now() + Math.floor(Math.random() * 10000), clientId: client.id, ramo: ramo, company: item.compagnia, notes: item.tipoPolizza || '', policyNumber: item.numeroPolizza || '', effect: effectDate.toISOString().split('T')[0], expiry: item.dataScadenza, split: split, annualPremium: annual, commPerc: 35, status: item.status === 'attiva' ? 'ATTIVA' : 'ANNULLATA', titles: titles }; policies.push(newPol); newP++; }); saveAllData(); alert(`Importati ${newC} clienti e ${newP} polizze.`); location.reload(); } catch (err) { console.error(err); alert("Errore nel file JSON."); } }; reader.readAsText(file); }

        function renderClients(list = null) {
            const tb = document.getElementById('clientsTableBody');
            const searchVal = document.getElementById('searchInput').value;
            let data = list || [];
            if((!list || list.length === 0) && searchVal.length === 0) {
                data = getRecentClientsList(5);
                if(data.length === 0) {
                    document.getElementById('client-count').innerText = "0";
                    tb.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500"><i class="fa-solid fa-magnifying-glass mb-2 text-2xl"></i><br>Utilizza la barra di ricerca.</td></tr>`;
                    return;
                }
            } document.getElementById('client-count').innerText = data.length; tb.innerHTML = '';
            if (data.length === 0) { tb.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500">Nessun cliente trovato.</td></tr>`; return; }
            data.slice(0, 50).forEach(c => { let badge = c.relation ? `<div class="mt-1 flex items-center gap-1 text-[10px] text-darktext bg-accent px-2 py-0.5 rounded font-bold w-fit"><i class="fa-solid fa-link"></i> ${c.relation.type} di ${c.relation.name}</div>` : ''; const row = `<tr class="hover:bg-slate-800/30 border-b border-slate-800/50 last:border-0 cursor-pointer" onclick="openClientDetail(${c.id})"><td class="px-6 py-4 font-medium text-white"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full bg-accent text-darktext flex items-center justify-center text-sm font-bold">${c.name.charAt(0).toUpperCase()}</div><div><div class="text-sm font-semibold">${c.name}</div>${badge}</div></div></td><td class="px-6 py-4"><div class="font-mono text-xs text-slate-300">${c.cf}</div></td><td class="px-6 py-4 text-sm text-slate-300">${c.phone||'-'}</td><td class="px-6 py-4 text-right space-x-2"><button onclick="alert('Note: ' + ('${c.notes}' || 'Nessuna'))" class="w-8 h-8 rounded-full border border-slate-700 text-yellow-500 hover:bg-slate-700 hover:text-white transition-all"><i class="fa-regular fa-note-sticky"></i></button><button onclick="event.stopPropagation(); filterPoliciesByClient(${c.id})" class="w-8 h-8 rounded-full border border-slate-700 text-info hover:bg-info hover:text-white transition-all"><i class="fa-solid fa-file-contract"></i></button><button onclick="event.stopPropagation(); openModal(${c.id})" class="w-8 h-8 rounded-full border border-slate-700 text-accent hover:bg-accent hover:text-darktext transition-all"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="event.stopPropagation(); deleteClient(${c.id})" class="w-8 h-8 rounded-full border border-slate-700 text-slate-500 hover:text-red-400 hover:bg-slate-700 transition-all" title="Elimina cliente"><i class="fa-solid fa-trash"></i></button></td></tr>`; tb.innerHTML += row; });
        }
        function openModal(id=null, viewOnly=false) { 
            document.getElementById('clientModal').classList.remove('hidden'); 
            if(id){
                editingClientId=id; 
                const c=clients.find(x=>x.id===id); 
                if(c){ 
                    document.getElementById('inputName').value=c.name; 
                    document.getElementById('inputCF').value=c.cf; 
                    document.getElementById('inputEmail').value=c.email||''; 
                    document.getElementById('inputPhone').value=c.phone||''; 
                    document.getElementById('inputBirthDate').value=c.birthDate||''; // DATA DI NASCITA
                    document.getElementById('inputAddress').value=c.address||''; 
                    document.getElementById('inputNotes').value=c.notes||''; 
                    document.getElementById('modalTitle').innerText="Modifica"; 
                    document.getElementById('submitBtn').innerText="Aggiorna"; 
                }
            } else {
                editingClientId=null; 
                document.getElementById('clientForm').reset(); 
                document.getElementById('modalTitle').innerText="Nuovo Cliente"; 
                document.getElementById('submitBtn').innerText="Salva";
            } 
            
            // VIEW MODE
            if(id && viewOnly){
                setClientModalReadOnly(true);
                const sb = document.getElementById('submitBtn');
                if(sb){
                    sb.dataset.prevType = sb.type;
                    sb.type = 'button';
                    sb.innerText = 'Modifica';
                    sb.onclick = () => {
                        setClientModalReadOnly(false);
                        sb.type = sb.dataset.prevType || 'submit';
                        sb.onclick = null;
                        document.getElementById('modalTitle').innerText = 'Modifica';
                        sb.innerText = 'Aggiorna';
                    };
                }
                document.getElementById('modalTitle').innerText = 'Dettaglio Cliente';
            } else {
                setClientModalReadOnly(false);
                const sb = document.getElementById('submitBtn');
                if(sb && sb.type === 'button' && sb.innerText === 'Modifica'){
                    sb.type = sb.dataset.prevType || 'submit';
                    sb.onclick = null;
                }
            }

            const s=document.getElementById('relationSelect'); s.innerHTML='<option value="">Nessuno</option>'; clients.forEach(c=>{if(c.id!==id){const o=document.createElement('option');o.value=c.id;o.text=c.name;s.appendChild(o);}}); 
        }

        // =============================
        // DETTAGLIO CLIENTE (VIEW MODE)
        // =============================
        function setClientModalReadOnly(isReadOnly){
            const ids = ['inputName','inputCF','inputEmail','inputPhone','inputBirthDate','inputAddress','inputNotes','relationSelect','relationType'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                if(el.tagName === 'SELECT' || el.type === 'date') el.disabled = !!isReadOnly;
                else el.readOnly = !!isReadOnly;
            });
        }

        function openClientDetail(id){
            openModal(id, true);
        }

        function closeModal() { document.getElementById('clientModal').classList.add('hidden'); }
        
        // --- SAVE CLIENT CON LOGICA BIDIREZIONALE ---
        function saveClient(e) { 
            e.preventDefault(); 
            const nm=document.getElementById('inputName').value, 
                  cf=document.getElementById('inputCF').value.toUpperCase(), 
                  em=document.getElementById('inputEmail').value, 
                  ph=document.getElementById('inputPhone').value, 
                  bd=document.getElementById('inputBirthDate').value, // DATA DI NASCITA
                  ad=document.getElementById('inputAddress').value, 
                  nt=document.getElementById('inputNotes').value, 
                  ri=document.getElementById('relationSelect').value, 
                  rt=document.getElementById('relationType').value, 
                  cid=editingClientId||Date.now(); 
            
            let rl=null; 
            
            // 1. Definisco la relazione per il cliente corrente
            if(ri){
                const p=clients.find(x=>x.id==ri);
                if(p) rl={id:ri,name:p.name,type:rt};
            } 
            
            const d={id:cid,name:nm,cf,email:em,phone:ph,birthDate:bd,address:ad,notes:nt,relation:rl,createdAt:new Date().toLocaleDateString('it-IT')}; 
            
            // 2. Salvo il cliente corrente
            if(editingClientId){
                const i=clients.findIndex(x=>x.id===editingClientId);
                clients[i]=d;
            } else {
                clients.push(d);
            } 
            
            // 3. AGGIORNO IL CLIENTE COLLEGATO (BIDIREZIONALE)
            if(ri) {
                const targetIdx = clients.findIndex(c => c.id == ri);
                if(targetIdx !== -1) {
                    let inverseType = 'Socio'; // Default fallback
                    if (rt === 'Coniuge') inverseType = 'Coniuge';
                    else if (rt === 'Socio') inverseType = 'Socio';
                    else if (rt === 'Genitore') inverseType = 'Figlio/a';
                    else if (rt === 'Figlio/a') inverseType = 'Genitore';

                    // Aggiorno il record dell'altro cliente
                    clients[targetIdx].relation = {
                        id: cid,
                        name: nm,
                        type: inverseType
                    };
                }
            }
                consolidateDuplicatePolicies();

            saveAllData(); 
            closeModal(); 
            renderClients([d]); 
            updateDashboard(); // Aggiorna widget compleanni
        }

        // --- FUNZIONE PARSE CF ---
        function parseCF() {
            const cf = document.getElementById('inputCF').value.toUpperCase();
            if(cf.length !== 16) return;

            const mapMonths = { 'A':0, 'B':1, 'C':2, 'D':3, 'E':4, 'H':5, 'L':6, 'M':7, 'P':8, 'R':9, 'S':10, 'T':11 };
            
            try {
                const yearStr = cf.substring(6, 8);
                const monthChar = cf.substring(8, 9);
                const dayStr = cf.substring(9, 11);

                if(!mapMonths.hasOwnProperty(monthChar)) return;

                let year = parseInt(yearStr);
                let month = mapMonths[monthChar];
                let day = parseInt(dayStr);

                // Calcolo sesso e giorno
                if(day > 40) {
                    day -= 40;
                }

                // Calcolo anno (euristica: se > anno corrente + 1, è 19xx, altrimenti 20xx)
                const currentYearTwoDigits = parseInt(new Date().getFullYear().toString().substr(2,2));
                if(year > currentYearTwoDigits) {
                    year += 1900;
                } else {
                    year += 2000;
                }

                const dateObj = new Date(year, month, day);
                dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset());
                
                document.getElementById('inputBirthDate').value = dateObj.toISOString().split('T')[0];
            } catch(e) {
                console.log("Errore parsing CF", e);
            }
        }

        function searchPoliciesByNumber(){
            const q = (document.getElementById('searchPolicyNumber')?.value || '').trim().toUpperCase();
            if(!q){
                renderContractsDefault();
                return;
            }
            currentActiveClientId = null;
            const list = policies.filter(p => String(p.policyNumber || '').toUpperCase().includes(q));
            renderPolicies(list, false);
            const st = document.getElementById('contract-subtitle');
            if(st) st.innerText = 'Ricerca numero polizza: ' + q;
            const btn = document.getElementById('btn-show-all-contracts');
            if(btn) btn.classList.remove('hidden');
        }


        function searchClients() { const q=document.getElementById('searchInput').value.toLowerCase(); if(q.length===0){renderClients(); return;} renderClients(clients.filter(c=>c.name.toLowerCase().includes(q)||c.cf.toLowerCase().includes(q))); }

        function updateCommDefaults() { const r=document.querySelector('input[name="ramo"]:checked')?.value; if(r){ document.getElementById('polCommPerc').value = (r==='VITA')?50:35; generateInstallmentPreview(); } }
        function openPolicyModalWithFilter() { openPolicyModal(currentActiveClientId); }
        function openPolicyModal(pre=null, edit=null) { 
            document.getElementById('policyModal').classList.remove('hidden'); document.getElementById('policyForm').reset(); document.getElementById('titlesPreview').innerHTML='<p class="text-slate-500 italic">Inserisci premio...</p>';
            const sel=document.getElementById('polClientSelect'); sel.innerHTML='<option value="">Seleziona...</option>'; clients.sort((a,b)=>a.name.localeCompare(b.name)).forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.text=c.name; if(pre&&c.id==pre)o.selected=true; sel.appendChild(o);});
            if(edit){editingPolicyId=edit; const p=policies.find(x=>x.id===edit); if(p){document.getElementById('polModalTitle').innerText="Modifica"; sel.value=p.clientId; document.querySelector(`input[name="ramo"][value="${p.ramo}"]`).checked=true; document.getElementById('polCommPerc').value=p.commPerc||35; if(['ALLIANZ','HDI','VITTORIA','HELVETIA','GENIALPIU','ARAG','METLIFE'].includes(p.company))document.getElementById('polCompany').value=p.company; else {document.getElementById('polCompany').value='ALTRO';document.getElementById('polCustomCompany').value=p.company;document.getElementById('polCustomCompany').classList.remove('hidden');} document.getElementById('polNotes').value=p.notes; document.getElementById('polNumber').value=p.policyNumber || ''; document.getElementById('polEffectDate').value=p.effect; document.getElementById('polExpiryDate').value=p.expiry; document.getElementById('polSplit').value=p.split; document.getElementById('polAnnualPremium').value=p.annualPremium; document.getElementById('titlesPreview').innerHTML='<p class="text-warning text-xs">Attenzione: modificando, i titoli verranno rigenerati.</p>';}}
            else{editingPolicyId=null; document.getElementById('polModalTitle').innerText="Nuova Polizza";}
        }
        function closePolicyModal(){document.getElementById('policyModal').classList.add('hidden'); editingPolicyId=null;}
        function checkCustomCompany(){const v=document.getElementById('polCompany').value; const i=document.getElementById('polCustomCompany'); if(v==='ALTRO')i.classList.remove('hidden'); else i.classList.add('hidden');}
        
        function safeParseFloat(val) { if(!val) return 0; if(typeof val === 'number') return val; return parseFloat(val.replace(',', '.')); }



        function toISODateLocal(d){
            const x = new Date(d);
            x.setHours(12,0,0,0);
            return new Date(x.getTime() - x.getTimezoneOffset()*60000).toISOString().split('T')[0];
        }

        // =============================
        // ULTIMI VISTI (Clienti/Polizze)
        // =============================
        function recentClientsKey(){ return currentUser ? `evanEsse_recentClients_${currentUser.uid}` : 'evanEsse_recentClients'; }
        function recentPoliciesKey(){ return currentUser ? `evanEsse_recentPolicies_${currentUser.uid}` : 'evanEsse_recentPolicies'; }

        function getRecentIds(key, limit=5){
            try { return (JSON.parse(localStorage.getItem(key)) || []).slice(0, limit); }
            catch(e){ return []; }
        }

        function pushRecentId(key, id, limit=5){
            if(id === null || id === undefined) return;
            let arr = [];
            try { arr = JSON.parse(localStorage.getItem(key)) || []; } catch(e){}
            arr = arr.filter(x => x != id);
            arr.unshift(id);
            arr = arr.slice(0, limit);
            localStorage.setItem(key, JSON.stringify(arr));
        }

        function getRecentPoliciesList(limit=5){
            const ids = getRecentIds(recentPoliciesKey(), limit);
            return ids.map(id => policies.find(p => p.id == id)).filter(Boolean);
        }

        function getRecentClientsList(limit=5){
            const ids = getRecentIds(recentClientsKey(), limit);
            return ids.map(id => clients.find(c => c.id == id)).filter(Boolean);
        }

        function renderContractsDefault(){
            const recent = getRecentPoliciesList(5);
            if(recent.length > 0){
                renderPolicies(recent, false);
                const st = document.getElementById('contract-subtitle');
                if(st) st.innerText = 'Ultime 5 viste';
                const btn = document.getElementById('btn-show-all-contracts');
                if(btn) btn.classList.remove('hidden');
            } else {
                renderPolicies(null, false);
            }
        }


        // ==========================================
        // CONDIVISIONE SCADENZE (WhatsApp/SMS/Email)
        // ==========================================
        const COMPANY_PAYMENT = {
            'ALLIANZ': { payee: 'VITRANI LUIGI AGENTE ASSICURATIVO', iban: 'IT45N0538766470000001289367' },
            'HDI': { payee: 'PV CONSULENZE ASSICURATIVE DI POLIGANI GINO & C. SAS', iban: 'IT02M0538766470000002538265' },
            'ARAG': { payee: 'PV CONSULENZE ASSICURATIVE DI POLIGANI GINO & C. SAS', iban: 'IT02M0538766470000002538265' },
            'HELVETIA': { payee: 'APSA SRL', iban: 'IT93W0306912711100000011938' },
            'METLIFE': { payee: 'METLIFE EUROPE D.A.C.', iban: 'IT25F0306912711100000018243' },
            'VITTORIA': { payee: 'RUBIERA ASSICURA DI POLIGANI GINO & C. SAS', iban: 'IT58J0303266470010000866029' },
            'GENIALPIU': { payee: 'GENIALPIU’', iban: '09-0200512' },
            '': { payee: '', iban: 'IT50O0358901600010570015482' },
        };

        function normalizeCompanyKey(company) {
            if(!company) return '';
            return String(company)
                .toUpperCase()
                .replace(/’/g, "'")
                .replace(/[^A-Z0-9 ]/g, '')
                .replace(/\s+/g, ' ')
                .trim()
                .replace("GENIALPIU'", 'GENIALPIU')
                .replace('GENIALPIU ', 'GENIALPIU');
        }

        function getCompanyPaymentInfo(company) {
            const key = normalizeCompanyKey(company);
            return COMPANY_PAYMENT[key] || { payee: '', iban: '' };
        }

        function cleanPhoneForWhatsApp(phone) {
            if(!phone) return '';
            let p = String(phone).trim();
            p = p.replace(/[^0-9+]/g, '');
            if(p && !p.startsWith('+')) {
                p = '+39' + p.replace(/^0+/, '');
            }
            return p;
        }

        function buildDeadlineMessage(deadline) {
            const pay = getCompanyPaymentInfo(deadline.comp);

            const dueStr = (() => {
                if (!deadline.dueDate) return '';
                try {
                    const d = new Date(String(deadline.dueDate).slice(0,10) + 'T12:00:00');
                    return d.toLocaleDateString('it-IT');
                } catch (e) {
                    return String(deadline.dueDate);
                }
            })();

            const lines = [
                '🔔 Promemoria scadenza assicurativa',
                '',
                'Gentile ' + deadline.cname + ',',
                'ti ricordiamo la prossima scadenza del tuo titolo assicurativo:',
                '',
                '📅 Data scadenza: ' + (dueStr || '-'),
                (deadline.rata ? ('🧾 Rata: ' + deadline.rata) : null),
                '👤 Nominativo: ' + deadline.cname,
                '📂 Ramo: ' + (deadline.ramo || '-'),
                '🏢 Compagnia: ' + (deadline.comp || '-'),
                '🆔 Numero polizza: ' + (deadline.polNum || '-'),
                '💶 Importo: € ' + Number(deadline.amount || 0).toFixed(2),
            ].filter(x => x !== null);

            if (pay.iban) {
                lines.push('');
                lines.push('🏦 Dati per il pagamento:');
                lines.push('Beneficiario: ' + (pay.payee || ''));
                lines.push('IBAN: ' + pay.iban);
            }

            lines.push('');
            lines.push('Per qualsiasi necessità puoi contattarci.');
            lines.push('Grazie per la collaborazione.');
            return lines.join('\n');
        }

        function shareDeadline(pid, tid, channel) {
            const p = policies.find(x => x.id == pid);
            if(!p) return alert('Polizza non trovata');
            const t = (p.titles || []).find(x => x.id == tid);
            if(!t) return alert('Titolo non trovato');
            const c = clients.find(x => x.id == p.clientId);

            const deadline = {
                pid: p.id,
                tid: t.id,
                cname: c ? c.name : 'Cliente',
                ramo: p.ramo,
                comp: p.company,
                polNum: p.policyNumber,
                amount: t.amount, dueDate: t.dueDate, rata: t.n,
                phone: c ? c.phone : '',
                email: c ? c.email : ''
            };

            const msg = buildDeadlineMessage(deadline);
            const enc = encodeURIComponent(msg);

            if(channel === 'whatsapp') {
                const waPhone = cleanPhoneForWhatsApp(deadline.phone);
                const url = waPhone ? `https://wa.me/${waPhone.replace('+','')}?text=${enc}` : `https://wa.me/?text=${enc}`;
                window.open(url, '_blank');
                return;
            }

            if(channel === 'sms') {
                const smsTo = deadline.phone ? cleanPhoneForWhatsApp(deadline.phone).replace('+','') : '';
                const url = smsTo ? `sms:${smsTo}?&body=${enc}` : `sms:?&body=${enc}`;
                window.location.href = url;
                return;
            }

            if(channel === 'email') {
                const to = deadline.email ? encodeURIComponent(deadline.email) : '';
                const subject = encodeURIComponent('Scadenza titolo assicurativo');
                const url = `mailto:${to}?subject=${subject}&body=${enc}`;
                window.location.href = url;
                return;
            }

            alert('Canale non supportato');
        }

        // Matitina provvigioni (solo rinnovi): modifica provvigione personale (commPers)
        
function editRenewalAmount(pid, tid){
            const p = policies.find(x => String(x.id) === String(pid));
            if(!p) return alert('Polizza non trovata');

            const t = (p.titles || []).find(x => String(x.id) === String(tid));
            if(!t || t.isRenewal !== true) return alert('Funzione disponibile solo sui rinnovi.');

            const curr = Number(t.amount || 0).toFixed(2);
            const val = prompt('Inserisci premio titolo (rinnovo)', curr);
            if(val === null) return;

            const newAmt = safeParseFloat(val);
            if(isNaN(newAmt)) return alert('Valore non valido');

            t.amount = newAmt;

            // Mensile (split 12): se modifichi una rata di rinnovo, aggiorna anche le altre rate di rinnovo dello stesso anno
            if(Number(p.split) === 12 && t.dueDate){
                const y = String(t.dueDate).slice(0,4);
                (p.titles || []).forEach(tt => {
                    if(tt === t) return;
                    if(tt.isRenewal === true && String(tt.dueDate || '').slice(0,4) === y){
                        tt.amount = newAmt;
                        // Provvigioni solo sulla prima rata dell'anno
                        if(Number(tt.n) !== 1){
                            tt.commTotal = 0;
                            tt.commPers = 0;
                        }
                    }
                });

                p.annualPremium = parseFloat((newAmt * 12).toFixed(2));
            } else {
                if(Number(p.annualPremium || 0) === 0) p.annualPremium = newAmt;
            }

            saveAllData();
            renderDeadlines();
            updateDashboard();
            if(currentViewingPolicyId == p.id) openPolicyTitles(p.id);
        }
        function editRenewalCommissionTotal(pid, tid){const p=policies.find(x=>String(x.id)==String(pid));if(!p)return alert('Polizza non trovata');const t=p.titles.find(x=>String(x.id)==String(tid));if(!t||t.isRenewal!==true)return alert('Funzione disponibile solo sui rinnovi.');const curr=Number(t.commTotal||0).toFixed(2);const val=prompt('Inserisci provvigione totale (rinnovo)',curr);if(val===null)return;const newTot=safeParseFloat(val);if(isNaN(newTot))return alert('Valore non valido');t.commTotal=newTot;const perc=safeParseFloat(p.commPerc||0);t.commPers=parseFloat((newTot*perc/100).toFixed(2));saveAllData();renderDeadlines();updateDashboard();if(currentViewingPolicyId==p.id)openPolicyTitles(p.id);}
function editRenewalCommission(pid, tid) {
            const p = policies.find(x => x.id == pid);
            if(!p) return alert('Polizza non trovata');
            const t = (p.titles || []).find(x => x.id == tid);
            if(!(t && t.isRenewal === true)) return alert('Funzione disponibile solo sui rinnovi.');

            const curr = Number(t.commPers || 0).toFixed(2);
            const val = prompt('Inserisci provvigione (tua) per questo titolo (€):', curr);
            if(val === null) return;
            const newPers = safeParseFloat(val);
            if(isNaN(newPers)) return alert('Valore non valido');

            t.commPers = newPers;

            saveAllData();
            renderDeadlines();
            updateDashboard();
            if(currentViewingPolicyId === p.id) openPolicyTitles(p.id);
        }

        // Elimina titolo (rata)
        function deleteTitle(polId, titId) {
            const p = policies.find(x => x.id === polId);
            if(!p) return;
            const t = (p.titles || []).find(x => x.id === titId);
            if(!t) return;
            if(!confirm('Eliminare il titolo (rata) ' + (t.n || '') + ' del ' + (new Date(t.dueDate).toLocaleDateString('it-IT')) + '?')) return;

            p.titles = (p.titles || []).filter(x => x.id !== titId);
            p.titles.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            p.titles.forEach((x, i) => { x.n = i+1; });

            saveAllData();
            renderDeadlines();
            updateDashboard();
            if(currentViewingPolicyId === polId) openPolicyTitles(polId);
            renderPolicies(currentActiveClientId, true);
        }

        // Unisce eventuali polizze duplicate (stesso Cliente + Compagnia + Numero polizza)
        // Mantiene una polizza "principale" e accorpa i titoli, aggiornando la scadenza al massimo.
        function consolidateDuplicatePolicies() {
            if(!Array.isArray(policies) || policies.length === 0) return;

            const keyOf = (p) => `${p.clientId}||${p.company}||${p.policyNumber}`;
            const groups = new Map();
            policies.forEach(p => {
                const k = keyOf(p);
                if(!groups.has(k)) groups.set(k, []);
                groups.get(k).push(p);
            });

            const newPolicies = [];

            groups.forEach(list => {
                if(list.length === 1) {
                    newPolicies.push(list[0]);
                    return;
                }

                let base = list.find(p => Number(p.annualPremium || 0) > 0) || list[0];
                const canonical = list.find(p => Number(p.annualPremium || 0) > 0) || base;

                const allTitles = [];
                list.forEach(p => (p.titles || []).forEach(t => allTitles.push(t)));

                const seen = new Set();
                const mergedTitles = [];
                allTitles.forEach(t => {
                    const k = `${t.dueDate}||${t.isRenewal===true}||${Number(t.amount||0).toFixed(2)}`;
                    if(seen.has(k)) return;
                    seen.add(k);
                    mergedTitles.push(t);
                });

                mergedTitles.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
                mergedTitles.forEach((t, idx) => { t.n = idx + 1; });

                const maxExpiry = list.reduce((mx, p) => {
                    const d = new Date(p.expiry);
                    return (!mx || d > mx) ? d : mx;
                }, null);

                const minEffect = list.reduce((mn, p) => {
                    const d = new Date(p.effect);
                    return (!mn || d < mn) ? d : mn;
                }, null);

                base.company = canonical.company;
                base.policyNumber = canonical.policyNumber;
                base.ramo = canonical.ramo || base.ramo;
                base.split = canonical.split || base.split;
                base.commPerc = (canonical.commPerc !== undefined && canonical.commPerc !== null) ? canonical.commPerc : base.commPerc;
                base.annualPremium = (Number(canonical.annualPremium || 0) > 0) ? canonical.annualPremium : base.annualPremium;

                if(maxExpiry) base.expiry = maxExpiry.toISOString().split('T')[0];
                if(minEffect) base.effect = minEffect.toISOString().split('T')[0];

                base.titles = mergedTitles;
                newPolicies.push(base);
            });

            policies = newPolicies;
        }

        function generateInstallmentPreview() {
            const s=parseInt(document.getElementById('polSplit').value),
                  a=safeParseFloat(document.getElementById('polAnnualPremium').value),
                  perc=safeParseFloat(document.getElementById('polCommPerc').value)||0,
                  c=document.getElementById('titlesPreview');
            if(s===null || s===undefined) return;
            let count=(s===1?1:(s===0?1:s)), amt=(count? (a/count) : a).toFixed(2);
            let html='<table class="w-full text-left text-xs text-slate-400"><thead><tr><th>N°</th><th>Importo</th><th>Provv. Tot</th><th>Provv. Pers ('+perc+'%)</th></tr></thead><tbody>';
            for(let i=0;i<count;i++){
                const lockSDD = (s===12 && i>0);
                const disAttr = lockSDD ? 'disabled' : '';
                const valAttr = lockSDD ? 'value="0"' : '';
                const lockNum = lockSDD ? 1 : 0;
                html += '<tr>'+
                  '<td class="py-1">'+(i+1)+'</td>'+
                  '<td class="text-white">€ '+amt+'</td>'+
                  '<td><input id="prev-ct-'+i+'" type="number" class="bg-deep border border-slate-700 w-16 px-1 rounded text-white" placeholder="0.00" '+disAttr+' '+valAttr+
                    ' oninput="updatePrevPersonalCommission('+i+', this.value, '+perc+', '+lockNum+')"></td>'+
                  '<td class="text-accent" id="prev-cp-'+i+'">€ 0.00</td>'+
                '</tr>';
            }
            html += '</tbody></table>';
            c.innerHTML = html;
        }

        function savePolicy(e){
            e.preventDefault(); 
            try {
                const cid=document.getElementById('polClientSelect').value;
                const ramoEl=document.querySelector('input[name="ramo"]:checked');
                if(!ramoEl) throw new Error("Seleziona un Ramo");
                const ramo = ramoEl.value;
                const commPerc=safeParseFloat(document.getElementById('polCommPerc').value)||0;
                let comp=document.getElementById('polCompany').value; if(comp==='ALTRO')comp=document.getElementById('polCustomCompany').value;
                const notes=document.getElementById('polNotes').value;
                const polNum=document.getElementById('polNumber').value;
                const eff=document.getElementById('polEffectDate').value;
                const exp=document.getElementById('polExpiryDate').value;
                
                if(!eff || !exp) throw new Error("Date mancanti");
                
                const split=parseInt(document.getElementById('polSplit').value);
                const annual=safeParseFloat(document.getElementById('polAnnualPremium').value);
                
                let titles=[], count=(split===1?1:(split===0?1:split)), amt=annual/count, dateObj=new Date(eff + 'T12:00:00');
                for(let i=0;i<count;i++){
                    let dd=new Date(dateObj); if(split===2)dd.setMonth(dateObj.getMonth()+(i*6)); else if(split===3)dd.setMonth(dateObj.getMonth()+(i*4)); else if(split===4)dd.setMonth(dateObj.getMonth()+(i*3)); else if(split===12)dd.setMonth(dateObj.getMonth()+i);
                    const ctEl = document.getElementById(`prev-ct-${i}`);
                    const cTotBase = safeParseFloat(ctEl ? ctEl.value : 0) || 0;
                    const cTot = (split===12 && i>0) ? 0 : cTotBase;
                    const cPersBase = parseFloat((cTot * (commPerc || 0) / 100).toFixed(2));
                    const cPers = (split===12 && i>0) ? 0 : cPersBase;
                    titles.push({id:Date.now()+i, n:i+1, dueDate:toISODateLocal(dd), amount:amt, status:'DA INCASSARE', commTotal:cTot, commPers:cPers});
                }
                const pData={id:editingPolicyId||Date.now(), clientId:cid, ramo, company:comp, notes, policyNumber:polNum, effect:eff, expiry:exp, split, annualPremium:annual, commPerc, status:'ATTIVA', titles};
                if(editingPolicyId){const idx=policies.findIndex(p=>p.id===editingPolicyId); policies[idx]=pData;} else {policies.push(pData);}
                saveAllData(); closePolicyModal(); renderPolicies(); updateDashboard();
            } catch(err) {
                alert("Errore salvataggio: " + err.message);
            }
        }

        // GENERATORE DI RINNOVI MASSIVO - CORRETTO
        function generateBulkRenewals() {
            const targetInput = document.getElementById('bulkRenewalInput').value;
            if(!targetInput) return alert("Seleziona mese e anno target.");

            const [tYear, tMonth] = targetInput.split('-');
            
            // CORREZIONE: Usiamo l'anno selezionato, senza sottrarre 1.
            const sYear = parseInt(tYear); 
            const sMonth = tMonth;

            // Filtro polizze scadute nel mese/anno sorgente
            const policiesToRenew = policies.filter(p => {
                if(p.status !== 'ATTIVA') return false;
                const d = new Date(p.expiry);
                // Javascript months 0-11
                return d.getFullYear() === sYear && (d.getMonth() + 1) === parseInt(sMonth);
            });

            if(policiesToRenew.length === 0) return alert(`Nessuna polizza in scadenza trovata nel periodo di riferimento (${sMonth}/${sYear})`);

            let created = 0;
            policiesToRenew.forEach(oldP => {
                // Controllo se esiste già un rinnovo (stesso cliente, compagnia, data effetto = vecchia scadenza)
                const alreadyExists = policies.some(newP => 
                    newP.clientId === oldP.clientId && 
                    newP.company === oldP.company && 
                    newP.effect === oldP.expiry 
                );

                if(!alreadyExists) {
                    const newEff = new Date(oldP.expiry);
                    const newExp = new Date(oldP.expiry);
                    newExp.setFullYear(newExp.getFullYear() + 1);

                    let titles = [];
                    let count = (oldP.split === 1 ? 1 : (oldP.split === 0 ? 1 : oldP.split));
                    
                    // Genero titoli con IMPORTO ZERO
                    for(let i=0; i<count; i++){
                        let dd = new Date(newEff);
                        if(oldP.split===2) dd.setMonth(newEff.getMonth()+(i*6));
                        else if(oldP.split===3) dd.setMonth(newEff.getMonth()+(i*4));
                        else if(oldP.split===4) dd.setMonth(newEff.getMonth()+(i*3));
                        else if(oldP.split===12) dd.setMonth(newEff.getMonth()+i);

                        titles.push({
                            id: Date.now() + Math.floor(Math.random()*1000000),
                            n: i+1,
                            dueDate: toISODateLocal(dd),
                            amount: 0, // IMPORTO ZERO
                            status: 'DA INCASSARE',
                            commTotal: 0,
                            commPers: 0
                        });
                    }

                    const newP = {
                        id: Date.now() + Math.floor(Math.random()*1000000),
                        clientId: oldP.clientId,
                        ramo: oldP.ramo,
                        company: oldP.company,
                        notes: "Rinnovo automatico da " + (oldP.policyNumber || ''),
                        policyNumber: oldP.policyNumber, 
                        effect: newEff.toISOString().split('T')[0],
                        expiry: newExp.toISOString().split('T')[0],
                        split: oldP.split,
                        annualPremium: 0, 
                        commPerc: oldP.commPerc,
                        status: 'ATTIVA',
                        titles: titles
                    };
                    policies.push(newP);
                    created++;
                }
            });

            saveAllData();
            alert(`Generati ${created} rinnovi per ${tMonth}/${tYear}.`);
            renderDeadlines(); // Aggiorna tabella scadenze
        }

        // FUNZIONE RINNOVO SINGOLO
        function renewPolicy(id) {
            const p = policies.find(x => x.id === id);
            if(!p) return;
            if(!confirm("Creare i titoli di rinnovo per la polizza " + (p.policyNumber || '') + "?\nImporti e provvigioni verranno azzerati e potranno essere inseriti con la matita.")) return;

            const newEff = new Date(p.expiry);
            const newExp = new Date(p.expiry);
            newExp.setFullYear(newExp.getFullYear() + 1);

            const effIso = newEff.toISOString().split('T')[0];
            const already = (p.titles || []).some(t => (t.isRenewal === true) && t.dueDate >= effIso);
            if(already) return alert('Rinnovo già presente (titoli già creati).');

            let titles = [];
            let count = (p.split === 1 ? 1 : (p.split === 0 ? 1 : p.split));
            for(let i=0; i<count; i++){
                let dd = new Date(newEff);
                if(p.split===2) dd.setMonth(newEff.getMonth()+(i*6));
                else if(p.split===3) dd.setMonth(newEff.getMonth()+(i*4));
                else if(p.split===4) dd.setMonth(newEff.getMonth()+(i*3));
                else if(p.split===12) dd.setMonth(newEff.getMonth()+i);

                titles.push({
                    id: Date.now() + Math.floor(Math.random()*1000000),
                    n: 0,
                    dueDate: toISODateLocal(dd),
                    amount: 0,
                    status: 'DA INCASSARE',
                    commTotal: 0,
                    commPers: 0,
                    isRenewal: true
                });
            }

            p.titles = (p.titles || []).concat(titles);
            p.titles.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            p.titles.forEach((t, idx) => { t.n = idx + 1; });
            p.expiry = newExp.toISOString().split('T')[0];

            consolidateDuplicatePolicies();
            saveAllData();

            renderDeadlines();
            renderPolicies(currentActiveClientId, true);
            updateDashboard();
            alert('Rinnovo creato: ' + titles.length + ' titoli aggiunti alla polizza.');
        }

        // RENDER POLIZZE - CORRETTO PER SOSPENSIONE
        function renderPolicies(filteredList = null, showMonthOnly = true) {
            let list = filteredList || policies;
            if (!filteredList && showMonthOnly) {
                const now = new Date();
                list = list.filter(p => { const d = new Date(p.expiry); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); });
                document.getElementById('contract-subtitle').innerText = "Scadenze Mese Corrente";
                document.getElementById('btn-show-all-contracts').classList.remove('hidden');
            } else if (!filteredList && !showMonthOnly) {
                document.getElementById('contract-subtitle').innerText = "Tutte le polizze";
                document.getElementById('btn-show-all-contracts').classList.add('hidden');
            }
            const tb = document.getElementById('policiesTableBody'); document.getElementById('policy-count').innerText=list.length; tb.innerHTML=''; 
            if(list.length===0){tb.innerHTML='<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">Nessuna polizza trovata per i criteri selezionati.</td></tr>';return;} 
            
            // CORREZIONE: Data odierna locale
            const now = new Date();
            const todayStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

            list.slice().reverse().forEach(p=>{
                const c=clients.find(x=>x.id==p.clientId)?.name||'Ex'; 
                let rc=''; if(p.ramo==='AUTO')rc='branch-auto'; else if(p.ramo==='VITA')rc='branch-vita'; else rc='branch-vari'; 
                
                // LOGICA STATO DINAMICO SOSPENSIONE RIGOROSA
                let displayStatus = p.status;
                
                if (p.suspensionStart && p.suspensionEnd) {
                    if (todayStr >= p.suspensionStart && todayStr <= p.suspensionEnd) {
                        displayStatus = 'SOSPESA';
                    } else {
                        // Se oggi è fuori dal range, deve tornare ATTIVA (se non è annullata/sostituita)
                        if(displayStatus === 'ATTIVA' || displayStatus === 'SOSPESA') {
                            displayStatus = 'ATTIVA';
                        }
                    }
                }
                
                let sb=`<span class="bg-slate-800 text-xs px-2 py-1 rounded text-white border border-slate-600">${displayStatus}</span>`; 
                if(displayStatus==='ANNULLATA')sb=`<span class="bg-red-900/30 text-xs px-2 py-1 rounded text-red-500 border border-red-900">ANNULLATA</span>`; 
                if(displayStatus==='SOSTITUITA')sb=`<span class="bg-yellow-900/30 text-xs px-2 py-1 rounded text-yellow-500 border border-yellow-900">SOSTITUITA</span>`; 
                if(displayStatus==='SOSPESA')sb=`<span class="bg-purple-900/30 text-xs px-2 py-1 rounded text-purple-500 border border-purple-900">SOSPESA</span>`; 
                
                let btnRenew = ''; 
                if(p.status === 'ATTIVA' || displayStatus === 'SOSPESA') { btnRenew = `<button onclick="renewPolicy(${p.id})" class="text-xs border border-accent text-accent hover:bg-slate-800 px-2 py-1 rounded" title="Genera Rinnovo Annuale"><i class="fa-solid fa-calendar-plus"></i></button>`; }
                
                const row=`<tr class="hover:bg-slate-800/30 border-b border-slate-800/50 last:border-0 ${rc} ${displayStatus!=='ATTIVA' && displayStatus!=='SOSPESA'?'opacity-60':''}"><td class="px-6 py-4">${sb}</td><td class="px-6 py-4 text-white font-medium">${c}</td><td class="px-6 py-4"><div class="text-sm font-bold text-white">${p.company}</div><div class="text-xs text-slate-400 mt-1">${p.policyNumber||''}</div><div class="text-[10px] uppercase border border-slate-700 rounded px-1 w-fit mt-1">${p.ramo}</div></td><td class="px-6 py-4 font-mono text-xs text-slate-300">${new Date(p.expiry).toLocaleDateString('it-IT')}</td><td class="px-6 py-4 text-right font-mono text-white">€ ${p.annualPremium.toFixed(2)}</td><td class="px-6 py-4 text-center space-x-1">${btnRenew}<button onclick="openClaimModal(${p.id}, null)" class="text-xs border border-slate-700 text-warning hover:bg-slate-800 px-2 py-1 rounded" title="Apri sinistro"><i class="fa-solid fa-triangle-exclamation"></i></button><button onclick="openPolicyTitles(${p.id})" class="text-xs border border-slate-700 text-info hover:bg-slate-800 px-2 py-1 rounded"><i class="fa-solid fa-list-ol"></i></button><button onclick="openPolicyModal(null, ${p.id})" class="text-xs border border-slate-700 text-slate-300 hover:bg-slate-800 px-2 py-1 rounded"><i class="fa-solid fa-pen"></i></button><button onclick="suspendPolicy(${p.id})" class="text-xs border border-slate-700 text-purple-400 hover:bg-slate-800 px-2 py-1 rounded" title="Sospendi"><i class="fa-solid fa-pause"></i></button><button onclick="cancelPolicy(${p.id})" class="text-xs border border-slate-700 text-red-400 hover:bg-slate-800 px-2 py-1 rounded"><i class="fa-solid fa-ban"></i></button><button onclick="replacePolicy(${p.id})" class="text-xs border border-slate-700 text-blue-400 hover:bg-slate-800 px-2 py-1 rounded"><i class="fa-solid fa-right-left"></i></button><button onclick="deletePolicy(${p.id})" class="text-xs border border-slate-700 text-slate-500 hover:text-red-600 px-2 py-1 rounded"><i class="fa-solid fa-trash"></i></button></td></tr>`; 
                tb.innerHTML+=row;
            }); 
        }
        
        function filterPoliciesByClient(id){switchSection('contracts'); currentActiveClientId=id; pushRecentId(recentClientsKey(), id, 5); const c=clients.find(x=>x.id==id); if(c){document.getElementById('contract-subtitle').innerText=`Filtro: ${c.name}`; renderPolicies(policies.filter(p=>p.clientId==id)); document.getElementById('btn-show-all-contracts').classList.remove('hidden');} }
        function resetContractFilter(showAll=false){ currentActiveClientId=null; renderPolicies(null, !showAll); }
        function cancelPolicy(id){const p=policies.find(x=>x.id===id); if(!p||p.status!=='ATTIVA')return; const d=prompt("Data annullamento (AAAA-MM-GG):", new Date().toISOString().split('T')[0]); if(!d)return; p.status='ANNULLATA'; p.titles.forEach(t=>{if(t.dueDate>=d && t.status==='DA INCASSARE')t.status='ANNULLATO';}); saveAllData(); renderPolicies(); updateDashboard();}
        function replacePolicy(id){const old=policies.find(x=>x.id===id); if(!old)return; if(!confirm("Sostituire?"))return; const d=new Date().toISOString().split('T')[0]; old.status='SOSTITUITA'; old.titles.forEach(t=>{if(t.dueDate>=d && t.status==='DA INCASSARE')t.status='ANNULLATO';}); openPolicyModal(null,null); document.getElementById('polClientSelect').value=old.clientId; document.querySelector(`input[name="ramo"][value="${old.ramo}"]`).checked=true; if(['ALLIANZ','HDI','VITTORIA','HELVETIA','GENIALPIU','ARAG','METLIFE'].includes(old.company))document.getElementById('polCompany').value=old.company; else{document.getElementById('polCompany').value='ALTRO';document.getElementById('polCustomCompany').value=old.company;document.getElementById('polCustomCompany').classList.remove('hidden');} document.getElementById('polNotes').value="Sostituzione"; document.getElementById('polEffectDate').value=d; document.getElementById('polExpiryDate').value=old.expiry; document.getElementById('polSplit').value=old.split; document.getElementById('polAnnualPremium').value=old.annualPremium; saveAllData(); renderPolicies();}
        function deletePolicy(id){if(confirm("Eliminare?")){policies=policies.filter(p=>p.id!==id); saveAllData(); renderPolicies(); updateDashboard();}}
        

        function deleteClient(clientId){
            const c = (clients||[]).find(x => String(x.id) === String(clientId));
            if(!c) return alert('Cliente non trovato.');

            const polCount = (policies||[]).filter(p => String(p.clientId) === String(clientId)).length;
            const msg =
                "Eliminare l'anagrafica:
" +
                "- " + (c.name || "") + "
" +
                "- CF: " + (c.cf || "") + "

" +
                "Verranno eliminate anche " + polCount + " polizze collegate.

" +
                "Confermi?";

            if(!confirm(msg)) return;

            (clients||[]).forEach(x => {
                if(x && x.relation && x.relation.id && String(x.relation.id) === String(clientId)) x.relation = null;
            });

            policies = (policies||[]).filter(p => String(p.clientId) !== String(clientId));
            clients = (clients||[]).filter(x => String(x.id) !== String(clientId));

            if(String(currentActiveClientId) === String(clientId)) currentActiveClientId = null;

            saveAllData();
            renderClients();
            renderPolicies(currentActiveClientId, true);
            renderDeadlines();
            updateDashboard();
        }

        function suspendPolicy(id) {
            const p = policies.find(x => x.id === id);
            if (!p || (p.status !== 'ATTIVA' && p.status !== 'SOSPESA')) return; 

            // Helper per parsare GG/MM/AAAA
            const parseIt = (s) => {
                if(!s) return null;
                const parts = s.split('/');
                if(parts.length !== 3) return null;
                return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // YYYY-MM-DD
            };

            const sStr = prompt("Data Inizio Sospensione (GG/MM/AAAA):");
            if (!sStr) return;
            const d1 = parseIt(sStr);
            if(!d1 || isNaN(d1)) return alert("Formato data non valido (usa GG/MM/AAAA)");

            const eStr = prompt("Data Riattivazione Prevista (GG/MM/AAAA):");
            if (!eStr) return;
            const d2 = parseIt(eStr);
            if(!d2 || isNaN(d2)) return alert("Formato data non valido (usa GG/MM/AAAA)");

            if(d2 <= d1) return alert("La data di riattivazione deve essere successiva all'inizio.");

            const days = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));

            p.suspensionStart = d1.toISOString().split('T')[0];
            p.suspensionEnd = d2.toISOString().split('T')[0];
            
            // Sposto scadenza
            let newExp = new Date(p.expiry);
            newExp.setDate(newExp.getDate() + days);
            p.expiry = newExp.toISOString().split('T')[0];

            // Sposto rate future
            const sIso = d1.toISOString().split('T')[0];
            p.titles.forEach(t => {
                if(t.status === 'DA INCASSARE' && t.dueDate > sIso) {
                    let d = new Date(t.dueDate);
                    d.setDate(d.getDate() + days);
                    t.dueDate = d.toISOString().split('T')[0];
                }
            });

            p.status = 'ATTIVA'; // Salvo sempre come attiva, la visualizzazione è dinamica
            
            saveAllData();
            renderPolicies();
        }

        function openPolicyTitles(polId){
            pushRecentId(recentPoliciesKey(), polId, 5);
            currentViewingPolicyId = polId;
            document.getElementById('policyTitlesModal').classList.remove('hidden');
            const p = (policies||[]).find(x=>x.id===polId);
            const tb = document.getElementById('policyTitlesBody');
            tb.innerHTML = '';
            if(!p){ return; }
            const perc = p.commPerc || 0;

            (p.titles||[]).forEach(t=>{
                let st = 'text-white';
                let sl = t.status;

                if(t.status === 'INCASSATO'){
                    st = 'text-success font-bold';
                    const d = t.paymentDate ? new Date(t.paymentDate).toLocaleDateString('it-IT') : '';
                    const md = t.paymentMethod ? (' - ' + t.paymentMethod) : '';
                    if(d) sl += ' (' + d + md + ')';
                } else if(t.status === 'ANNULLATO'){
                    st = 'text-red-500';
                }

                const pay = (t.status==='DA INCASSARE' && p.status!=='ANNULLATA' && p.status!=='SOSTITUITA');
                const canUndo = (t.status==='INCASSATO' && p.status!=='ANNULLATA' && p.status!=='SOSTITUITA');

                const payBtn = pay
                    ? '<button onclick="openPaymentModal('+polId+','+t.id+')" class="bg-success text-white px-2 py-1 rounded text-xs font-bold hover:bg-green-600" title="Incassa"><i class="fa-solid fa-coins"></i></button>'
                    : '';

                const undoBtn = canUndo
                    ? '<button onclick="cancelPayment('+polId+','+t.id+')" class="bg-slate-700 text-white px-2 py-1 rounded text-xs font-bold hover:bg-slate-600" title="Annulla incasso"><i class="fa-solid fa-rotate-left"></i></button>'
                    : '';

                const canEditDelete = (t.status !== 'INCASSATO' && t.status !== 'ANNULLATO');

                const editBtn = canEditDelete
                    ? '<button onclick="editTitle('+polId+','+t.id+')" class="text-yellow-400 hover:text-white px-2 py-1 rounded text-xs" title="Modifica importo"><i class="fa-solid fa-pen-to-square"></i></button>'
                    : '';

                const dateBtn = canEditDelete
                    ? '<button onclick="editTitleDate('+polId+','+t.id+')" class="text-sky-300 hover:text-white px-2 py-1 rounded text-xs" title="Modifica data"><i class="fa-solid fa-calendar-day"></i></button>'
                    : '';

                const delBtn = canEditDelete
                    ? '<button onclick="deleteTitle('+polId+','+t.id+')" class="text-red-400 hover:text-red-300 px-2 py-1 rounded text-xs" title="Elimina titolo"><i class="fa-solid fa-trash"></i></button>'
                    : '';

                tb.innerHTML += `
                <tr class="hover:bg-slate-800/30 border-b border-slate-800/50 last:border-0 ${t.status==='ANNULLATO'?'status-cancelled':''}">
                    <td class="px-4 py-3 font-mono text-xs text-white">${new Date(t.dueDate).toLocaleDateString('it-IT')}</td>
                    <td class="px-4 py-3 text-xs text-slate-400">${t.n || ''}</td>
                    <td class="px-4 py-3 font-mono text-white">€ ${Number(t.amount||0).toFixed(2)}</td>
                    <td><input type="number" class="bg-deep border border-slate-700 w-20 px-1 rounded text-xs text-white" value="${t.commTotal||0}" oninput="calcLivePersonale(${t.id}, this.value, ${perc})" onchange="updateCommTotal(${polId}, ${t.id}, this.value)"></td>
                    <td><input type="number" id="pers-${t.id}" class="bg-deep border border-slate-700 w-20 px-1 rounded text-xs text-accent font-bold" value="${t.commPers||0}" onchange="updateCommPersonal(${polId}, ${t.id}, this.value)"></td>
                    <td class="px-4 py-3 text-xs ${st}">${sl}</td>
                    <td class="px-4 py-3 text-right space-x-2">${payBtn}${undoBtn}${editBtn}${dateBtn}${delBtn}</td>
                </tr>`;
            });
        }
        function closePolicyTitles(){document.getElementById('policyTitlesModal').classList.add('hidden'); currentViewingPolicyId=null;}
        function calcLivePersonale(tid, val, perc) { const tot = safeParseFloat(val); const pers = (tot * perc / 100).toFixed(2); document.getElementById('pers-'+tid).value = pers; }
        // UPDATE FUNZIONI: ORA CHIAMANO renderDeadlines() invece di renderTitles()
        function updateCommTotal(polId, titId, val) {
            const p = policies.find(x => x.id === polId);
            if(!p) return;
            const t = (p.titles || []).find(x => x.id === titId);
            if(!t) return;

            const newTot = safeParseFloat(val);
            if(isNaN(newTot)) return;

            // FIX SDD mensile (split=12): provvigioni annuali SOLO sulla 1ª rata di rinnovo
            if(Number(p.split) === 12 && t.isRenewal === true){
                const rts = (p.titles || []).filter(x => x.isRenewal === true)
                    .sort((a,b)=> new Date(a.dueDate) - new Date(b.dueDate));
                const first = rts[0];

                if(first && String(t.id) !== String(first.id)){
                    alert('SDD mensile: le provvigioni vanno inserite solo sul 1° titolo di rinnovo.');
                    t.commTotal = 0;
                    t.commPers = 0;
                } else {
                    t.commTotal = newTot;
                    const perc = safeParseFloat(p.commPerc || 0);
                    t.commPers = parseFloat((newTot * perc / 100).toFixed(2));

                    // tutte le altre rate rinnovo sempre a 0
                    rts.forEach(x => {
                        if(first && String(x.id) !== String(first.id)){
                            x.commTotal = 0;
                            x.commPers = 0;
                        }
                    });
                }
            } else {
                // comportamento standard: aggiorna solo questo titolo
                t.commTotal = newTot;
                const perc = safeParseFloat(p.commPerc || 0);
                t.commPers = parseFloat((newTot * perc / 100).toFixed(2));
            }

            saveAllData();
            openPolicyTitles(polId);
            renderDeadlines();
        }
        function updateCommPersonal(polId, titId, val) {
            const p = policies.find(x => x.id === polId);
            if(!p) return;
            const t = (p.titles || []).find(x => x.id === titId);
            if(!t) return;

            const newVal = safeParseFloat(val);
            if(isNaN(newVal)) return;

            // FIX SDD mensile (split=12): provvigioni annuali SOLO sulla 1ª rata di rinnovo
            if(Number(p.split) === 12 && t.isRenewal === true){
                const rts = (p.titles || []).filter(x => x.isRenewal === true)
                    .sort((a,b)=> new Date(a.dueDate) - new Date(b.dueDate));
                const first = rts[0];

                if(first && String(t.id) !== String(first.id)){
                    alert('SDD mensile: le provvigioni vanno inserite solo sul 1° titolo di rinnovo.');
                    t.commPers = 0;
                    t.commTotal = 0;
                } else {
                    t.commPers = newVal;
                    // tutte le altre rate rinnovo sempre a 0
                    rts.forEach(x => {
                        if(first && String(x.id) !== String(first.id)){
                            x.commTotal = 0;
                            x.commPers = 0;
                        }
                    });
                }
            } else {
                // comportamento standard: aggiorna solo questo titolo
                t.commPers = newVal;
            }

            saveAllData();
            openPolicyTitles(polId);
            renderDeadlines();
        }
        
        // MODIFICATO PER GESTIRE IL PROMPT O IL CALCOLO DI NUOVO IMPORTO
        
        function editTitleDate(polId, titId){
            const p = (policies||[]).find(x => String(x.id) === String(polId));
            if(!p) return alert('Polizza non trovata.');
            const t = (p.titles||[]).find(x => String(x.id) === String(titId));
            if(!t) return alert('Titolo non trovato.');

            if(t.status === 'INCASSATO' || t.status === 'ANNULLATO')
                return alert('Non è possibile modificare la data di un titolo INCASSATO o ANNULLATO.');

            const curr = String(t.dueDate || '').slice(0,10);
            const val = prompt('Nuova data scadenza (AAAA-MM-GG):', curr);
            if(val === null) return;

            const newDate = String(val).trim();
            if(!/^\d{4}-\d{2}-\d{2}$/.test(newDate))
                return alert('Formato data non valido. Usa AAAA-MM-GG.');

            t.dueDate = newDate;
            p.titles = (p.titles||[]).sort((a,b)=> new Date(String(a.dueDate||'1970-01-01')) - new Date(String(b.dueDate||'1970-01-01')));
            (p.titles||[]).forEach((x,i)=> x.n = i+1);

            saveAllData();
            renderDeadlines();
            updateDashboard();
            if(currentViewingPolicyId && String(currentViewingPolicyId) === String(polId)) openPolicyTitles(polId);
            renderPolicies(currentActiveClientId, true);
        }

function editTitle(polId, titId){ 
            const p=policies.find(x=>x.id===polId);
            const t=p.titles.find(x=>x.id===titId);
            const n=prompt("Nuovo importo:", t.amount); 
            
            if(n){
                const newAmt = safeParseFloat(n);
                t.amount=newAmt;
                
                // Aggiorna anche il totale polizza se è un rinnovo a zero
                if(p.annualPremium === 0) {
                    p.annualPremium = newAmt; // Semplificazione: assume rata unica o aggiorna solo display
                }
                
                saveAllData(); 
                if(currentViewingPolicyId===polId) openPolicyTitles(polId); 
                renderDeadlines();
            } 
        }

        // ==========================================
        // SCADENZARIO TITOLI (LOGICA COLORI + EXPORT PDF)
        // ==========================================
        function getFilteredDeadlines() {
            const fMo = document.getElementById('filterMonthDeadlines').value; 
            const fPayDate = document.getElementById('filterPayDateDeadlines').value; 
            const fStat = document.getElementById('filterStatusDeadlines').value; 
            const fComp = document.getElementById('filterCompDeadlines').value; 

            let all = [];
            policies.forEach(p => {
                if(fComp && p.company !== fComp) return;
                if(p.status === 'ANNULLATA' || p.status === 'SOSTITUITA') return;

                p.titles.forEach(t => {
                    if(fStat && t.status !== fStat) return;
                    if(fMo && !t.dueDate.startsWith(fMo)) return;
                    if(fPayDate) {
                        if(t.status !== 'INCASSATO') return;
                        if(!t.paymentDate || !t.paymentDate.startsWith(fPayDate)) return;
                    }

                    all.push({
                        ...t, 
                        pid: p.id, 
                        cname: clients.find(c => c.id == p.clientId)?.name || 'Unknown', 
                        comp: p.company,
                        polNum: p.policyNumber // ADDED FOR PDF & VIEW
                    });
                });
            });
            return all.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
        }

        function renderDeadlines(){
            autoCollectSDDTitles();
            const tb = document.getElementById('deadlinesTableBody'); 
            tb.innerHTML = '';
            
            const all = getFilteredDeadlines();
            const today = new Date(); 

            document.getElementById('deadlines-count').innerText = all.length;
            
            let totAmount = 0;
            let totComm = 0;

            all.forEach(t => {
                totAmount += t.amount || 0;
                totComm += t.commPers || 0;

                let rowClass = ""; 
                let statusIcon = "";
                let payBtn = "";

                const dueDate = new Date(t.dueDate);
                const diffTime = today - dueDate; 
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 

                if (t.status === 'INCASSATO') {
                    rowClass = "row-paid";
                    const md = t.paymentMethod ? (' - '+t.paymentMethod) : '';
                    statusIcon = `<span class="text-success font-bold">INCASSATO <span class="text-[10px] text-slate-500 block">${new Date(t.paymentDate).toLocaleDateString()}${md}</span></span>`;
                    payBtn = `<button onclick=\"cancelPayment(${t.pid},${t.id})\" class=\"bg-slate-700 text-white px-3 py-1 rounded-md text-xs font-bold hover:bg-slate-600 shadow-lg\"><i class=\"fa-solid fa-rotate-left\"></i> ANNULLA</button>`;
                } else {
                    if (diffDays > 15) {
                        rowClass = "row-expired";
                        statusIcon = '<span class="text-red-500 font-bold"><i class="fa-solid fa-triangle-exclamation"></i> SCADUTO</span>';
                    } else if (diffDays >= -5 && diffDays <= 15) {
                        rowClass = "row-warning";
                        statusIcon = '<span class="text-yellow-500 font-bold"><i class="fa-regular fa-clock"></i> IN SCADENZA</span>';
                    } else {
                        rowClass = ""; 
                        statusIcon = '<span class="text-white">DA INCASSARE</span>';
                    }

                    payBtn = `<button onclick="openPaymentModal(${t.pid},${t.id})" class="bg-success text-white px-3 py-1 rounded-md text-xs font-bold hover:bg-green-600 shadow-lg"><i class="fa-solid fa-coins"></i> INCASSA</button>`;
                }

                // GESTIONE IMPORTO ZERO (MATITA)
                let amountDisplay = `€ ${t.amount.toFixed(2)}`;
                if(t.amount === 0) {
                    amountDisplay = `<button onclick="editTitle(${t.pid}, ${t.id})" class="text-yellow-400 hover:text-white animate-pulse-slow font-bold text-lg" title="Inserisci Importo"><i class="fa-solid fa-pen-to-square"></i></button>`;
                }

                const row = `
                <tr class="border-b border-slate-800/50 last:border-0 ${rowClass}">
                    <td class="px-6 py-4 font-mono text-xs text-white">
                        ${dueDate.toLocaleDateString('it-IT')}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-bold text-white">${t.cname}</div>
                        <div class="text-[10px] text-slate-500">${t.comp}</div>
                        <div class="text-[10px] text-accent mt-0.5"><i class="fa-solid fa-hashtag"></i> ${t.polNum}</div>
                    </td>
                    <td class="px-6 py-4 text-xs text-slate-400">Rata ${t.n}</td>
                    <td class="px-6 py-4 font-mono text-white">${amountDisplay}</td>
                    <td class=\"px-6 py-4 font-mono text-accent font-bold\">€ ${(t.commPers||0).toFixed(2)}${(t.isRenewal && t.status!=='INCASSATO') ? ` <button onclick=\"editRenewalCommission(${t.pid}, ${t.id})\" class=\"text-yellow-400 hover:text-white ml-2\" title=\"Modifica provvigione (rinnovo)\"><i class=\"fa-solid fa-pen-to-square\"></i></button>` : ''}</td>
                    <td class="px-6 py-4 text-xs">
                        ${statusIcon}
                    </td>
                    <td class="px-6 py-4 text-right space-x-2">
                        ${payBtn}<button onclick=\"shareDeadline(${t.pid}, ${t.id}, 'whatsapp')\" class=\"text-xs text-green-400 hover:text-green-300 ml-2\" title=\"Invia WhatsApp\"><i class=\"fa-brands fa-whatsapp\"></i></button><button onclick=\"shareDeadline(${t.pid}, ${t.id}, 'sms')\" class=\"text-xs text-sky-400 hover:text-sky-300 ml-2\" title=\"Invia SMS\"><i class=\"fa-solid fa-comment-sms\"></i></button><button onclick=\"shareDeadline(${t.pid}, ${t.id}, 'email')\" class=\"text-xs text-slate-300 hover:text-white ml-2\" title=\"Invia Email\"><i class=\"fa-solid fa-envelope\"></i></button><button onclick=\"deleteTitle(${t.pid}, ${t.id})\" class=\"text-xs text-red-400 hover:text-red-300 ml-2\" title=\"Elimina titolo\"><i class=\"fa-solid fa-trash\"></i></button><button onclick=\"openPolicyTitles(${t.pid})\" class=\"text-xs text-slate-500 hover:text-accent ml-2\" title=\"Vedi Dettaglio\"><i class=\"fa-solid fa-eye\"></i></button>
                    </td>
                </tr>`;
                
                tb.innerHTML += row;
            });

            document.getElementById('deadlines-total-amount').innerText = '€ ' + totAmount.toFixed(2);
            document.getElementById('deadlines-total-comm').innerText = '€ ' + totComm.toFixed(2);
        }

        // --- FUNZIONE ESPORTAZIONE PDF CON TOTALI ---
        function exportDeadlinesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // 'l' = landscape (orizzontale)

            const data = getFilteredDeadlines();
            
            // Titolo e info header
            doc.setFontSize(16);
            doc.text("NEXA Manager", 14, 15);
            doc.setFontSize(10);
            doc.text("Data generazione: " + new Date().toLocaleDateString('it-IT'), 14, 22);

            // Filtro usato (opzionale)
            const fMo = document.getElementById('filterMonthDeadlines').value;
            if(fMo) doc.text("Filtro Mese: " + fMo, 200, 22);

            // Preparazione dati tabella e Calcolo Totali
            let totalAmount = 0;
            let totalComm = 0;

            const tableRows = data.map(item => {
                totalAmount += item.amount || 0;
                totalComm += item.commPers || 0;
                return [
                    new Date(item.dueDate).toLocaleDateString('it-IT'),
                    item.cname,
                    item.comp + "\n(" + (item.polNum || '-') + ")",
                    "Rata " + item.n,
                    "€ " + item.amount.toFixed(2),
                    "€ " + (item.commPers || 0).toFixed(2),
                    item.status === 'INCASSATO' ? `PAGATO (${new Date(item.paymentDate).toLocaleDateString()})` : 'DA INCASSARE'
                ];
            });

            // Aggiungi riga totale nel footer
            const footerRow = [
                'TOTALE', 
                '', 
                '', 
                '', 
                '€ ' + totalAmount.toFixed(2), 
                '€ ' + totalComm.toFixed(2), 
                ''
            ];

            doc.autoTable({
                head: [['Scadenza', 'Cliente', 'Compagnia (Polizza)', 'Dettaglio', 'Importo', 'Provvigioni', 'Stato']],
                body: tableRows,
                foot: [footerRow],
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [5, 7, 20] }, 
                footStyles: { fillColor: [226, 255, 0], textColor: [0, 0, 0], fontStyle: 'bold' }, // Footer giallo accent
                styles: { fontSize: 9 },
            });

            doc.save(`scadenzario_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // INCASSO
        function openPaymentModal(pid,tid){document.getElementById('paymentModal').classList.remove('hidden'); document.getElementById('payPolicyId').value=pid; document.getElementById('payTitleId').value=tid;}
        function closePaymentModal(){document.getElementById('paymentModal').classList.add('hidden');}
        
        function confirmPayment() {
  try {
    const policyId = String(document.getElementById('payPolicyId').value || '').trim();
    const titleId = String(document.getElementById('payTitleId').value || '').trim();
    const payDate = document.getElementById('payDate').value; // YYYY-MM-DD
    const method = document.getElementById('payMethod').value;

    if (!policyId || !titleId) return alert('Dati mancanti.');

    const pol = policies.find(p => String(p.id) === policyId);
    if (!pol) return alert('Polizza non trovata.');

    const t = (pol.titles || []).find(x => String(x.id) === titleId);
    if (!t) return alert('Titolo non trovato.');

    const isoPayDate = (payDate && String(payDate).trim()) ? String(payDate).trim() : null;

    // SDD mensile: se incassi con SDD, incassa tutte le 12 rate e imposta paymentDate = dueDate
    if (method === 'SDD' && Number(pol.split) === 12) {
      (pol.titles || []).forEach(tt => {
        tt.status = 'INCASSATO';
        tt.paymentMethod = 'SDD';
        tt.paymentDate = tt.dueDate ? String(tt.dueDate) : isoPayDate;
      });

      saveAllData();
      closePaymentModal();
      renderDeadlines();
      updateDashboard();
      if (currentViewingPolicyId == pol.id) openPolicyTitles(pol.id);
      return;
    }

    // Standard: incassa solo il titolo selezionato
    t.status = 'INCASSATO';
    t.paymentMethod = method;
    t.paymentDate = isoPayDate;

    saveAllData();
    closePaymentModal();
    renderDeadlines();
    updateDashboard();
    if (currentViewingPolicyId == pol.id) openPolicyTitles(pol.id);
  } catch (e) {
    console.error(e);
    alert('Errore registrazione incasso.');
  }
}



        function cancelPayment(pid, tid) {
  try {
    if (!confirm("Annullare l'incasso del titolo?")) return;
    const p = policies.find(x => String(x.id) === String(pid));
    if (!p) return;
    const t = (p.titles || []).find(x => String(x.id) === String(tid));
    if (!t) return;

    t.status = 'DA INCASSARE';
    t.paymentDate = null;
    t.paymentMethod = null;

    saveAllData();
    renderDeadlines();
    updateDashboard();
    if (currentViewingPolicyId && String(currentViewingPolicyId) === String(pid)) openPolicyTitles(pid);
  } catch (e) {
    console.log('cancelPayment', e);
  }
}



    </script>

<!-- CLAIMS MODAL -->
<div id="claimModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeClaimModal()"></div>

  <div class="absolute top-12 left-1/2 transform -translate-x-1/2 w-full max-w-4xl px-4">
    <div class="bg-surface border border-slate-700 rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto border-t-4 border-t-accent">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="text-xl font-bold text-white" id="claimModalTitle">Gestione Sinistro</h3>
          <p class="text-xs text-slate-500 mt-1">Compila i dati e aggiungi aggiornamenti (storico).</p>
        </div>
        <button onclick="closeClaimModal()" class="text-slate-500 hover:text-accent">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>

      <input type="hidden" id="claimId" />
      <input type="hidden" id="claimPolicyId" />

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs text-slate-500 font-bold mb-1">Numero Polizza</label>
          <input type="text" id="claimPolicyNumber" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm font-mono" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 font-bold mb-1">Compagnia</label>
          <input type="text" id="claimCompany" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 font-bold mb-1">Numero Sinistro</label>
          <input type="text" id="claimNumber" required class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm font-mono" />
        </div>

        <div>
          <label class="block text-xs text-slate-500 font-bold mb-1">Data Apertura</label>
          <input type="date" id="claimOpenDate" required class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" />
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="block text-xs text-slate-500 font-bold mb-1">Note</label>
          <textarea id="claimNotes" rows="2" class="w-full bg-deep border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" placeholder="Note interne..."></textarea>
        </div>

        <div class="flex items-center gap-3 bg-slate-800/30 border border-slate-700/50 rounded-xl px-4 py-3">
          <input type="checkbox" id="claimClosed" class="accent-accent bg-deep border-slate-700 h-4 w-4 rounded" onchange="onClaimClosedToggle()" />
          <label for="claimClosed" class="text-sm text-slate-300 font-bold select-none">Sinistro chiuso</label>
          <span class="text-xs text-slate-500 ml-auto" id="claimClosedAtLabel"></span>
        </div>
      </div>

      <div class="mt-6 border-t border-slate-800 pt-4">
        <div class="flex items-center justify-between gap-3 mb-3">
          <h4 class="text-sm font-bold text-white uppercase tracking-wide">Storico aggiornamenti</h4>
          <button onclick="addClaimUpdate()" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded-lg text-white border border-slate-600">
            <i class="fa-solid fa-plus mr-2"></i>Aggiungi
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
          <input type="datetime-local" id="claimUpdTs" class="bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white" />
          <input type="text" id="claimUpdText" placeholder="Testo aggiornamento..." class="md:col-span-3 bg-deep border border-slate-700 rounded px-3 py-2 text-xs text-white" />
        </div>

        <div id="claimUpdatesList" class="space-y-2 max-h-72 overflow-y-auto pr-2"></div>
      </div>

      <div class="flex gap-3 mt-6 pt-4 border-t border-slate-800">
        <button type="button" onclick="closeClaimModal()" class="flex-1 px-4 py-3 rounded-xl border border-slate-700 text-slate-300">Annulla</button>
        <button type="button" onclick="saveClaim()" class="flex-1 px-4 py-3 rounded-xl bg-accent text-darktext font-bold hover:bg-yellow-400">Salva</button>
      </div>
    </div>
  </div>
</div>



<script>
// =========================
// SINISTRI (CLAIMS) - V1
// =========================

// Data store
let claims = [];

function pad2(n){ return String(n).padStart(2,'0'); }
function isoToday(){
  const now = new Date();
  return new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().split('T')[0];
}
function isoNowLocal(){
  const now = new Date();
  const d = new Date(now.getTime() - now.getTimezoneOffset()*60000);
  return d.toISOString().slice(0,16);
}
function escapeHtml(str){
  return String(str ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function initClaimsFilters(){
  const mSel = document.getElementById('filterClaimMonth');
  const ySel = document.getElementById('filterClaimYear');
  if(!mSel || !ySel) return;

  mSel.innerHTML = `
    <option value="TUTTI">Tutti</option>
    <option value="01">Gennaio</option><option value="02">Febbraio</option><option value="03">Marzo</option>
    <option value="04">Aprile</option><option value="05">Maggio</option><option value="06">Giugno</option>
    <option value="07">Luglio</option><option value="08">Agosto</option><option value="09">Settembre</option>
    <option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option>
  `;

  const now = new Date();
  const curY = now.getFullYear();
  const curM = pad2(now.getMonth()+1);

  let yHtml = `<option value="TUTTI">Tutti</option>`;
  for(let y=2025; y<=2050; y++) yHtml += `<option value="${y}">${y}</option>`;
  ySel.innerHTML = yHtml;

  const st = document.getElementById('filterClaimStatus');
  if(st && !st.value) st.value = 'APERTI';
  mSel.value = curM;
  ySel.value = String(curY);
}

function getPolicyById(pid){
  try { return policies?.find(p => String(p.id) === String(pid)); } catch(e){ return null; }
}
function getClientNameById(cid){
  try { const c = clients?.find(x => String(x.id) === String(cid)); return c?.name || ''; } catch(e){ return ''; }
}

// --- legacy integration (wrap existing functions) ---
(function(){
  const _saveLocalBackup = (typeof saveLocalBackup === 'function') ? saveLocalBackup : null;

  // stop listeners
  if(_fbStopListeners){
      try { _ } catch(e){}
    };
  }

  // start listeners
  if(_fbStartListeners){
      _
      try {
        const uid = currentUser.uid;
          (qs) => {
                try{
            const arr = [];
            const known = new Set();
            qs.forEach(d => { arr.push(d.data()); known.add(d.id); });
            claims = arr;
renderClaims();
          
                } catch(e){
                } finally {
                        saveAllData();
                    }
                }
}
        );
    };
  }

  // full sync
  if(_fbFullSyncToFirestore){
      await _fbFullSyncToFirestore();
      // NB: _fbFullSyncToFirestore fa commit batch; qui facciamo un mini-batch separato per claims
      try {
        const uid = currentUser.uid;
        const seenClaims = new Set();

        (claims || []).forEach(cl => {
          if(!cl || cl.id === undefined || cl.id === null) return;
          const id = String(cl.id);
          seenClaims.add(id);
          batch.set(
            { merge: true }
          );
        });

        });

        await batch.commit();
    };
  }

  // local backup
  if(_saveLocalBackup){
    window.saveLocalBackup = function(){
      _saveLocalBackup();
      try{
        if(!currentUser || !currentUser.uid) return;
        localStorage.setItem('evanEsseclaims' + currentUser.uid, JSON.stringify(claims || []));
      } catch(e){}
    };
  }
})();

// --- Policy modal helper button uses openClaimModal(editingPolicyId...) already in HTML ---

// --- Claims Modal ---
function openClaimModal(policyId=null, claimId=null){
  const modal = document.getElementById('claimModal');
  if(!modal) return;

  modal.dataset.draft = '';

  document.getElementById('claimId').value = claimId ? String(claimId) : '';
  document.getElementById('claimPolicyId').value = policyId ? String(policyId) : '';

  document.getElementById('claimModalTitle').innerText = claimId ? 'Modifica Sinistro' : 'Nuovo Sinistro';
  document.getElementById('claimNumber').value = '';
  document.getElementById('claimOpenDate').value = isoToday();
  document.getElementById('claimNotes').value = '';
  document.getElementById('claimClosed').checked = false;
  document.getElementById('claimClosedAtLabel').innerText = '';
  document.getElementById('claimUpdatesList').innerHTML = '';
  document.getElementById('claimUpdTs').value = isoNowLocal();
  document.getElementById('claimUpdText').value = '';

  // policy values
  if(policyId){
    const p = getPolicyById(policyId);
    document.getElementById('claimPolicyNumber').value = p?.policyNumber || '';
    document.getElementById('claimCompany').value = p?.company || '';
  } else {
    document.getElementById('claimPolicyNumber').value = '';
    document.getElementById('claimCompany').value = '';
  }

  // edit
  if(claimId){
    const cl = (claims || []).find(x => String(x.id) === String(claimId));
    if(cl){
      document.getElementById('claimPolicyId').value = cl.policyId || '';
      document.getElementById('claimPolicyNumber').value = cl.policyNumber || '';
      document.getElementById('claimCompany').value = cl.company || '';
      document.getElementById('claimNumber').value = cl.claimNumber || '';
      document.getElementById('claimOpenDate').value = cl.openedAt || isoToday();
      document.getElementById('claimNotes').value = cl.notes || '';
      document.getElementById('claimClosed').checked = !!cl.closed;
      document.getElementById('claimClosedAtLabel').innerText = cl.closedAt ? `Chiuso il ${cl.closedAt}` : '';
      renderClaimUpdatesList(cl.updates || []);
      modal.dataset.draft = JSON.stringify({ updates: Array.isArray(cl.updates) ? cl.updates : [] });
    }
  }

  modal.classList.remove('hidden');
}

function closeClaimModal(){
  document.getElementById('claimModal')?.classList.add('hidden');
}

function onClaimClosedToggle(){
  const chk = document.getElementById('claimClosed');
  const lbl = document.getElementById('claimClosedAtLabel');
  if(!chk || !lbl) return;
  lbl.innerText = chk.checked ? `Chiuso il ${isoToday()}` : '';
}

function getModalClaimDraft(){
  const modal = document.getElementById('claimModal');
  if(!modal) return { updates: [] };
  try{
    const raw = modal.dataset.draft ? JSON.parse(modal.dataset.draft) : null;
    if(raw && Array.isArray(raw.updates)) return raw;
  }catch(e){}
  return { updates: [] };
}

function setModalClaimDraft(d){
  const modal = document.getElementById('claimModal');
  if(!modal) return;
  modal.dataset.draft = JSON.stringify({ updates: Array.isArray(d?.updates) ? d.updates : [] });
}

function renderClaimUpdatesList(updates){
  const box = document.getElementById('claimUpdatesList');
  if(!box) return;
  const arr = Array.isArray(updates) ? updates.slice() : [];
  arr.sort((a,b) => String(b.ts||'').localeCompare(String(a.ts||'')));

  if(arr.length === 0){
    box.innerHTML = `<div class="text-slate-500 text-xs italic">Nessun aggiornamento.</div>`;
    return;
  }

  box.innerHTML = '';
  arr.forEach(u => {
    const ts = u.ts ? String(u.ts).replace('T',' ') : '';
    const text = u.text || '';
    box.innerHTML += `
      <div class="p-3 rounded-xl bg-slate-800/30 border border-slate-700/50">
        <div class="flex items-start justify-between gap-3">
          <div class="text-xs text-accent font-bold">${escapeHtml(ts)}</div>
          <button class="text-xs text-red-400 hover:text-red-300" onclick="deleteClaimUpdate('${escapeHtml(u.id)}')" title="Elimina aggiornamento">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
        <div class="text-sm text-white mt-1 whitespace-pre-wrap break-words">${escapeHtml(text)}</div>
      </div>
    `;
  });
}

function addClaimUpdate(){
  const ts = document.getElementById('claimUpdTs')?.value || isoNowLocal();
  const text = document.getElementById('claimUpdText')?.value?.trim();
  if(!text) return alert('Inserisci testo aggiornamento.');

  const cur = getModalClaimDraft();
  cur.updates.push({ id: String(Date.now()) + String(Math.floor(Math.random()*1000)), ts, text });
  setModalClaimDraft(cur);

  document.getElementById('claimUpdText').value = '';
  document.getElementById('claimUpdTs').value = isoNowLocal();
  renderClaimUpdatesList(cur.updates);
}

function deleteClaimUpdate(updateId){
  const cur = getModalClaimDraft();
  cur.updates = cur.updates.filter(u => String(u.id) !== String(updateId));
  setModalClaimDraft(cur);
  renderClaimUpdatesList(cur.updates);
}

function saveClaim(){
  try{
    const claimId = document.getElementById('claimId').value || String(Date.now());
    const policyId = document.getElementById('claimPolicyId').value?.trim();
    const policyNumber = document.getElementById('claimPolicyNumber').value?.trim();
    const company = document.getElementById('claimCompany').value?.trim();
    const claimNumber = document.getElementById('claimNumber').value?.trim();
    const openedAt = document.getElementById('claimOpenDate').value;
    const notes = document.getElementById('claimNotes').value || '';
    const closed = !!document.getElementById('claimClosed').checked;

    if(!policyId) throw new Error('Collega il sinistro ad una polizza (apri dalla polizza).');
    if(!claimNumber) throw new Error('Numero sinistro obbligatorio.');
    if(!openedAt) throw new Error('Data apertura obbligatoria.');

    const p = getPolicyById(policyId);
    const clientId = p?.clientId || '';
    const clientName = getClientNameById(clientId);
    const draft = getModalClaimDraft();
    const updates = Array.isArray(draft.updates) ? draft.updates : [];

    const prev = (claims || []).find(x => String(x.id) === String(claimId));
    let closedAt = null;
    if(closed) closedAt = prev?.closedAt || isoToday();

    const obj = {
      id: String(claimId),
      policyId: String(policyId),
      policyNumber: policyNumber || p?.policyNumber || '',
      company: company || p?.company || '',
      clientId: clientId ? String(clientId) : '',
      clientName: clientName || '',
      claimNumber: String(claimNumber),
      openedAt: String(openedAt),
      notes: String(notes),
      closed: !!closed,
      closedAt: closedAt,
      updates: updates
    };

    const idx = (claims || []).findIndex(x => String(x.id) === String(claimId));
    if(idx >= 0) claims[idx] = obj; else claims.push(obj);

    saveAllData();
    closeClaimModal();
    renderClaims();
  } catch(err){
    alert('Errore salvataggio sinistro: ' + err.message);
  }
}

function deleteClaim(id){
  if(!confirm('Eliminare questo sinistro?')) return;
  claims = (claims || []).filter(x => String(x.id) !== String(id));
  saveAllData();
  renderClaims();
}

function quickToggleClaimClosed(id, isClosed){
  const idx = (claims || []).findIndex(x => String(x.id) === String(id));
  if(idx < 0) return;
  claims[idx].closed = !!isClosed;
  claims[idx].closedAt = isClosed ? (claims[idx].closedAt || isoToday()) : null;
  saveAllData();
  renderClaims();
}

function getLastUpdateText(updates){
  if(!Array.isArray(updates) || updates.length === 0) return '';
  const sorted = updates.slice().sort((a,b)=>String(b.ts||'').localeCompare(String(a.ts||'')));
  const u = sorted[0];
  const ts = u.ts ? String(u.ts).replace('T',' ') : '';
  const text = u.text || '';
  return `${ts} - ${text}`;
}

function renderClaims(){
  const tb = document.getElementById('claimsTableBody');
  if(!tb) return;

  const status = document.getElementById('filterClaimStatus')?.value || 'APERTI';
  const month = document.getElementById('filterClaimMonth')?.value || 'TUTTI';
  const year  = document.getElementById('filterClaimYear')?.value || 'TUTTI';
  const q = (document.getElementById('searchClaims')?.value || '').trim().toUpperCase();

  let list = Array.isArray(claims) ? claims.slice() : [];

  if(status === 'APERTI') list = list.filter(c => !c.closed);
  if(status === 'CHIUSI') list = list.filter(c => !!c.closed);

  list = list.filter(c => {
    const d = String(c.openedAt || '');
    if(year !== 'TUTTI' && !d.startsWith(String(year) + '-')) return false;
    if(month !== 'TUTTI' && d.slice(5,7) !== String(month)) return false;
    return true;
  });

  if(q){
    list = list.filter(c => {
      const pn = String(c.policyNumber || '').toUpperCase();
      const cn = String(c.claimNumber || '').toUpperCase();
      const cln = String(c.clientName || '').toUpperCase();
      const comp = String(c.company || '').toUpperCase();
      return pn.includes(q) || cn.includes(q) || cln.includes(q) || comp.includes(q);
    });
  }

  list.sort((a,b) => String(b.openedAt||'').localeCompare(String(a.openedAt||'')));

  tb.innerHTML = '';
  if(list.length === 0){
    tb.innerHTML = `<tr><td colspan="10" class="px-6 py-8 text-center text-slate-500">Nessun sinistro trovato.</td></tr>`;
    return;
  }

  list.forEach(c => {
    const closed = !!c.closed;
    const badge = closed
      ? `<span class="px-2 py-1 rounded text-xs font-bold bg-red-900/30 text-red-300 border border-red-700/40">CHIUSO</span>`
      : `<span class="px-2 py-1 rounded text-xs font-bold bg-emerald-900/30 text-emerald-300 border border-emerald-700/40">APERTO</span>`;

    const lastUpd = escapeHtml(getLastUpdateText(c.updates || []));
    const notes = escapeHtml((c.notes || '').slice(0,60));
    const pol = escapeHtml(c.policyNumber || '');
    const cli = escapeHtml(c.clientName || '');
    const comp = escapeHtml(c.company || '');

    tb.innerHTML += `
      <tr class="hover:bg-slate-800/30 border-b border-slate-80050 last:border-0">
        <td class="px-6 py-4">${badge}</td>
        <td class="px-6 py-4 font-mono text-xs text-white">${pol}</td>
        <td class="px-6 py-4 text-xs text-slate-200">${comp}</td>
        <td class="px-6 py-4 text-sm text-slate-200">${cli}</td>
        <td class="px-6 py-4 font-mono text-xs text-white">${escapeHtml(c.claimNumber||'')}</td>
        <td class="px-6 py-4 font-mono text-xs text-slate-300">${escapeHtml(c.openedAt||'')}</td>
        <td class="px-6 py-4 text-xs text-slate-300">${lastUpd}</td>
        <td class="px-6 py-4 text-xs text-slate-400">${notes}</td>
        <td class="px-6 py-4 text-center">
          <input type="checkbox" class="accent-accent h-4 w-4 rounded" ${closed ? 'checked' : ''}
                 onchange="quickToggleClaimClosed('${escapeHtml(c.id)}', this.checked)" />
        </td>
        <td class="px-6 py-4 text-right space-x-2">
          <button class="text-xs border border-slate-700 text-slate-300 hover:bg-slate-800 px-2 py-1 rounded" onclick="openClaimModal(null,'${escapeHtml(c.id)}')">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button class="text-xs border border-slate-700 text-slate-500 hover:text-red-300 hover:bg-slate-800 px-2 py-1 rounded" onclick="deleteClaim('${escapeHtml(c.id)}')">
            <i class="fa-solid fa-trash"></i>
          </button>
        </td>
      </tr>
    `;
  });
}

// --- Export/Import/Reset overrides ---

// Export include sinistri
function downloadBackup(){
  const data = { clients, policies, appointments, claims, currentUser };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `backup_evanesse_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}

// Import include sinistri
async function processImport(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async function(e){
    try{
      const data = JSON.parse(e.target.result);
      if(!confirm('ATTENZIONE: questa operazione sovrascriverà i dati attuali su legacy con quelli del backup. Procedere?')) return;

      const importBtn = document.querySelector('button[onclick="document.getElementById(\"importFile\").click()"]');
      if(importBtn) importBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Caricamento...';

      clients = data.clients || [];
      policies = data.policies || [];
      appointments = data.appointments || [];
      claims = data.claims || [];

      try{
        
        await manualSaveAll();
        alert('Importazione completata con successo! I dati sono stati salvati su Supabase.');
        location.reload();
        if(importBtn) importBtn.innerHTML = '<i class="fa-solid fa-upload text-info"></i> Importa Archivio';
        try{  }catch(e){}
      }
    } catch(err){
      console.error(err);
      alert('Il file selezionato non è valido.');
    }
  };
  reader.readAsText(file);
}

function resetDatabase(){
  if(!currentUser) { alert('Nessun profilo attivo.'); return; }
  if(!confirm('ATTENZIONE: questa operazione cancellerà SOLO i dati (clienti/polizze/agenda/sinistri) del profilo attualmente loggato.')) return;
  if(!confirm('Sicuro al 100%?')) return;

  try{
    localStorage.removeItem('evanEssedata' + currentUser.uid);
    localStorage.removeItem('evanEssepolicies' + currentUser.uid);
    localStorage.removeItem('evanEsseagenda' + currentUser.uid);
    localStorage.removeItem('evanEsseclaims' + currentUser.uid);
    localStorage.removeItem('evanEsserecentClients' + currentUser.uid);
    localStorage.removeItem('evanEsserecentPolicies' + currentUser.uid);
  } catch(e){ console.log(e); }

  clients = [];
  policies = [];
  appointments = [];
  claims = [];

  saveAllData();
  alert('Dati del profilo cancellati.');
  location.reload();
}

// --- Init hook ---
(function(){
  const _initApp = (typeof initApp === 'function') ? initApp : null;
  if(_initApp){
    window.initApp = function(){
      _initApp();
      initClaimsFilters();
      renderClaims();
    };
  }
})();



function setHeaderTitle(t, s){
  const pt = document.getElementById('page-title');
  const ps = document.getElementById('page-subtitle');
  if(pt) pt.innerText = t || '';
  if(ps) ps.innerText = s || '';
}

// Override per includere Sinistri e aggiornare sempre il titolo pagina
function switchSection(sectionName){
  try {
    document.getElementById('section-report')?.classList.add('hidden');
    document.getElementById('nav-report')?.classList.remove('nav-active');
  } catch(e){}

  ['home','clients','contracts','deadlines','agenda','report','claims'].forEach(id => {
    const el = document.getElementById(`section-${id}`);
    if(el) el.classList.add('hidden');
    const nav = document.getElementById(`nav-${id}`);
    if(nav) nav.classList.remove('nav-active');
  });

  const map = {
    home:      { t:'Dashboard', s:'Panoramica' },
    agenda:    { t:'Agenda', s:'Calendario e appuntamenti' },
    clients:   { t:'Clienti', s:'Anagrafica clienti' },
    contracts: { t:'Polizze', s:'Gestione portafoglio' },
    deadlines: { t:'Scadenze', s:'Scadenziario titoli' },
    report:    { t:'Report', s:'Analisi Produzione, Portafoglio e Polizze Perse' },
    claims:    { t:'Sinistri', s:'Gestione sinistri' }
  };
  const m = map[sectionName] || map.home;
  setHeaderTitle(m.t, m.s);

  if(sectionName === 'home'){
    document.getElementById('section-home')?.classList.remove('hidden');
    document.getElementById('nav-home')?.classList.add('nav-active');
    updateDashboard();
  } else if(sectionName === 'clients'){
    document.getElementById('section-clients')?.classList.remove('hidden');
    document.getElementById('nav-clients')?.classList.add('nav-active');
    renderClients();
  } else if(sectionName === 'contracts'){
    document.getElementById('section-contracts')?.classList.remove('hidden');
    document.getElementById('nav-contracts')?.classList.add('nav-active');
    renderContractsDefault();
  } else if(sectionName === 'deadlines'){
    document.getElementById('section-deadlines')?.classList.remove('hidden');
    document.getElementById('nav-deadlines')?.classList.add('nav-active');
    const fMoD = document.getElementById('filterMonthDeadlines');
    if(fMoD && !fMoD.value){
      const now = new Date();
      fMoD.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    }
    renderDeadlines();
  } else if(sectionName === 'report'){
    document.getElementById('section-report')?.classList.remove('hidden');
    document.getElementById('nav-report')?.classList.add('nav-active');
    initReportDefaults();
    renderReport();
  } else if(sectionName === 'agenda'){
    document.getElementById('section-agenda')?.classList.remove('hidden');
    document.getElementById('nav-agenda')?.classList.add('nav-active');
    renderAgendaMain();
  } else if(sectionName === 'claims'){
    document.getElementById('section-claims')?.classList.remove('hidden');
    document.getElementById('nav-claims')?.classList.add('nav-active');
    renderClaims();
  }
}
</script>

</body>
</html>
